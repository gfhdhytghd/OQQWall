<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OQQWall å®¡æ ¸é¢æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. å…¨å±€æ ·å¼ä¸æ–°é¢œè‰²ç³»ç»Ÿ */
        :root {
            --color-primary: #6750A4;
            --color-primary-container: #EADDFF;
            --color-on-primary-container: #21005D;
            --color-secondary: #625B71;
            --color-error: #B3261E;
            --color-surface-container-lowest: #FFFFFF;
            --color-surface-container-low: #F7F2FA;
            --color-surface-container-high: #ECE6F0;
            --color-surface-container-highest: #E6E0E9;
            --color-on-surface: #1C1B1F;
            --color-on-surface-variant: #49454F;
            --color-outline: #79747E;
            --color-outline-variant: #CAC4D0;
            --shadow-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --shadow-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --shadow-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Roboto", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-surface-container-low);
            color: var(--color-on-surface);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 2. å¡ç‰‡ä¸å¸ƒå±€ä¼˜åŒ– */
        /* Masonryï¼šCSS Grid + JS é‡æµ‹ï¼ˆæ›´ç¨³ï¼‰ */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            grid-auto-rows: auto;   /* é¦–å¸§ç”¨çœŸå®é«˜åº¦ï¼Œé‡æµ‹ååˆ‡æ¢ä¸º 1px å•ä½è¡Œé«˜ */
            grid-auto-flow: dense;
            column-gap: 24px;
            row-gap: 0;             /* è¡Œé—´è·ç”±å¡ç‰‡ margin-bottom æä¾›ï¼Œæ¶ˆé™¤é‡åŒ–è¯¯å·® */
        }

        .item-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            box-shadow: var(--shadow-2);
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0 0 24px;        /* å‚ç›´é—´è· */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;      /* ä¾›å³ä¸Šè§’å¾½ç« å®šä½ */
        }
        .item-card.processed { opacity: 0.8; }
        .highlight-new { animation: flash 1.5s ease-in-out; }
        @keyframes flash { 0%{box-shadow: 0 0 0 rgba(103,80,164,0);} 50%{box-shadow: 0 0 0 6px rgba(103,80,164,0.25);} 100%{box-shadow: 0 0 0 rgba(103,80,164,0);} }
        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-3);
        }

        .item-content {
            padding: 20px;
            flex-grow: 1;
        }
        
        /* 3. å­—ä½“å±‚çº§ä¼˜åŒ– */
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
            padding-right: 96px; /* ä¸ºå³ä¸Šè§’å¾½ç« é¢„ç•™ç©ºé—´ï¼Œé¿å…é‡å  */
        }

        .item-tag {
            font-size: 24px;
            font-weight: 500;
            color: var(--color-primary);
        }
        
        .info-item {
            font-size: 14px;
            color: var(--color-on-surface-variant);
            margin-top: 4px;
        }
        .info-item strong {
            font-weight: 500;
            color: var(--color-on-surface);
        }

        .item-badges { display:flex; gap:8px; position:absolute; top:10px; right:10px; z-index:2; }
        .badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-anonymous {
            background-color: #F8D7DA;
            color: #721C24;
        }
        .badge-images {
            background-color: #D4EDDA;
            color: #155724;
        }

        /* 4. ä¼˜åŒ–â€œç™½æ¡â€ -> èå…¥å¡ç‰‡çš„è®¾è®¡ */
        .item-comment {
            font-size: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background-color: var(--color-surface-container-low); /* ä½¿ç”¨æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
            border-radius: 12px;
            border-left: 4px solid var(--color-primary-container);
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }
        .item-sep {
            height: 1px;
            background: var(--color-outline-variant);
            margin: 12px 0 16px 0;
            border-radius: 1px;
        }
        
        /* 5. å›¾ç‰‡ç½‘æ ¼ï¼šä¸€è¡Œä¸‰åˆ—ï¼Œéšå¡ç‰‡å®½åº¦è‡ªé€‚åº” */
        .item-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .item-images img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1; /* ä¿æŒæ–¹å½¢ */
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--color-outline-variant);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .item-images img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-2);
        }

        /* 6. å…¶ä»–UIå…ƒç´ ç¾åŒ– */
        .comment-form {
            padding: 0px;
            margin: 0 0px;
        }
        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-outline-variant);
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 70px;
            background-color: var(--color-surface-container-low);
        }
        .comment-form textarea:focus {
            outline: 2px solid var(--color-primary);
            border-color: transparent;
        }

        .item-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 1:1:1 ä¸‰åˆ—å æ»¡ä¸€è¡Œ */
            gap: 10px;
            padding: 20px;
            background-color: var(--color-surface-container-high);
            border-radius: 0 0 16px 16px; /* åº•éƒ¨åœ†è§’ */
        }
        .item-actions .btn { width: 100%; height: 41px; padding: 0 12px; line-height: 1; }
        /* æ“ä½œåŒºæŒ‰é’®ï¼šåŠé€æ˜å¡«å…… + 2px å®å¿ƒå†…è¾¹æ¡† */
        .item-actions .btn { 
            background: rgba(202, 196, 208, 0.35); /* é»˜è®¤æ·¡ç°åŠé€æ˜ */
            box-shadow: inset 0 0 0 2px var(--color-outline-variant);
            color: #000; /* æ“ä½œåŒºæ–‡å­—ç»Ÿä¸€é»‘è‰² */
        }
        .item-actions .btn-success { background: rgba(40, 167, 69, 0.35); box-shadow: inset 0 0 0 2px #28a745; color:#000; }
        .item-actions .btn-warning { background: rgba(255, 193, 7, 0.35); box-shadow: inset 0 0 0 2px #ffc107; color:#000; }
        .item-actions .btn-danger { background: rgba(220, 53, 69, 0.35); box-shadow: inset 0 0 0 2px #dc3545; color:#000; }
        .item-actions .btn-info { background: rgba(23, 162, 184, 0.35); box-shadow: inset 0 0 0 2px #17a2b8; color:#000; }
        
        /* æŒ‰é’®ç¾åŒ– */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-1);
        }
        
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        /* é¡¶éƒ¨ç»Ÿè®¡å’Œç­›é€‰ */
        .header, .stats, .filters {
            margin-bottom: 24px;
        }

        .header {
            text-align: center;
        }
        h1 {
            font-size: 32px;
            font-weight: 500;
            color: var(--color-on-surface);
        }
        .header p {
            color: var(--color-on-surface-variant);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-1);
            border: 1px solid var(--color-outline-variant);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--color-on-surface-variant);
        }
        
        .filters {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-1);
        }
        
        .global-controls {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0 24px 0;
            box-shadow: var(--shadow-1);
        }
        .global-controls h2 { font-size: 18px; margin-bottom: 12px; font-weight: 600; }
        .global-row { display:grid; gap: 10px; align-items: center; }
        .global-row .note { grid-column: 1 / -1; color: var(--color-on-surface-variant); }
        .global-row .row-1 { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
        .global-row .row-2 { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; }
        /* ç»Ÿä¸€å…¨å±€æ“ä½œåŒºæŒ‰é’®é«˜åº¦ï¼ˆæ¡Œé¢40pxï¼Œç§»åŠ¨ç«¯ä¿æŒ60pxï¼‰ */
        .global-controls .btn { height: 40px; padding: 0 18px; line-height: 1; border-radius: 999px; }
        .global-controls .num-input { height: 40px; padding: 0 18px; line-height: 1; border-radius: 999px; }
        /* è¶…å¤§å±ï¼šåˆå¹¶ä¸ºä¸€è¡Œï¼ˆ9åˆ—ï¼‰ */
        @media (min-width: 1200px) {
            .global-row { grid-template-columns: repeat(9, auto); }
            .global-row .row-1, .global-row .row-2 { display: contents; }
        }
        /* ç§»åŠ¨ç«¯ï¼š3åˆ—å¸ƒå±€ï¼ˆæ¢å¤æŒ‰é’®é«˜åº¦60pxï¼‰ */
        @media (max-width: 768px) {
            .global-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .global-row .row-1, .global-row .row-2 { display: contents; }
            .global-controls .btn { height: 60px; }
            .global-controls .num-input { height: 60px; }
        }
        .select { padding: 10px 12px; border:1px solid var(--color-outline); border-radius: 12px; }
        .num-input { width: 100%; padding: 10px 16px; border:1px solid var(--color-outline); border-radius: 999px; background: #fff; }
        /* ç¾åŒ– number è¾“å…¥çš„åŠ å‡æŒ‰é’® */
        .num-input::-webkit-outer-spin-button,
        .num-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .num-input { -moz-appearance: textfield; }
        
        .filter-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
        }
        
        .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-outline);
            border-radius: 24px;
            font-size: 16px;
        }
        
        .empty-state {
            grid-column: 1 / -1; /* è®©ç©ºçŠ¶æ€å æ»¡æ•´è¡Œ */
            text-align: center;
            padding: 80px 20px;
        }
        
        /* æš‚å­˜åŒºæ ·å¼ */
        .staging-area {
            background: var(--color-surface-container-high);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-1);
        }
        .staging-area h2 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--color-on-surface-variant);
        }
        .staging-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }
        .staged-item {
            background: var(--color-surface-container-lowest);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            display: grid;
            grid-template-columns: 64px 1fr auto; /* thumbs | text | undo */
            grid-template-rows: auto auto;
            grid-template-areas:
                "thumbs meta undo"
                "thumbs info undo";
            gap: 8px 10px;
            box-shadow: var(--shadow-1);
        }
        .staged-item .thumbs { grid-area: thumbs; display:flex; flex-direction: row; gap:6px; }
        .staged-item .thumbs img { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; border:1px solid var(--color-outline-variant); background:#f6f6f6; }
        .staged-item .tag {
            font-weight: 700;
            color: var(--color-primary);
        }
        .staged-item .group {
            font-size: 12px;
            background: var(--color-primary-container);
            color: var(--color-on-primary-container);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .staged-item .meta { grid-area: meta; display:flex; align-items:center; gap:8px; }
        .staged-item .info { grid-area: info; color: var(--color-on-surface-variant); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .staged-item .undo { grid-area: undo; align-self: start; }
        .staged-item .undo .btn { padding: 6px 10px; font-size: 13px; }

        /* 7. ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            h1 { font-size: 24px; }
            /* ç§»åŠ¨ç«¯é€€åŒ–ä¸ºå•åˆ—ï¼Œä¿ç•™é—´è· */
            .items-grid { column-count: 1; column-width: auto; column-gap: 0; }
            .item-card { width: 100%; max-width: 100%; overflow: hidden; }
            .item-content { padding: 14px; }
            .item-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .item-tag { font-size: 20px; }
            .item-comment { font-size: 15px; padding: 12px; }
            /* æ”¹ä¸ºç½‘æ ¼å¸ƒå±€ï¼Œè‡ªåŠ¨æ¢è¡Œï¼Œé¿å…è¶…å®½ */
            .item-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; overflow-x: visible; }
            .item-images img { width: 100%; height: auto; aspect-ratio: 1 / 1; }
            /* æ“ä½œæŒ‰é’® 3 åˆ—å¸ƒå±€ */
            .item-actions { padding: 12px; gap: 8px; display: grid; grid-template-columns: repeat(3, 1fr); }
            .item-actions .btn { width: 100%; height: 41px; padding: 0 12px; font-size: 15px; line-height: 1; }
            .btn.btn-info[href^="/detail"] { flex: 1 1 100%; order: -1; }
            .filters { padding: 16px; }
            .filter-row { gap: 10px; }
            .filter-input { font-size: 15px; padding: 10px 14px; }
            .stats { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .stat-number { font-size: 24px; }
            .select, .num-input { max-width: 100%; }
            /* æš‚å­˜åŒºï¼šç§»åŠ¨ç«¯ä»…æ˜¾ç¤º1å¼ ç¼©ç•¥å›¾ï¼Œæ¨ªå‘å¸ƒå±€ */
            .staged-item { grid-template-columns: 64px 1fr; grid-template-areas: "thumbs meta" "thumbs info"; }
            .staged-item .thumbs { flex-direction: row; }
            .staged-item .thumbs img:not(:first-child) { display: none; }
        }

    </style>
</head>
<body>
    <div class="container">
        {userbar}
        {notice_html}
        <div class="header">
            <h1>OQQWall å®¡æ ¸é¢æ¿</h1>
            <p>ç®¡ç†æ ¡å›­å¢™æŠ•ç¨¿å†…å®¹ï¼Œç¡®ä¿å†…å®¹è´¨é‡å’Œç¤¾åŒºè§„èŒƒ</p>
        </div>
        <div style="display:flex;justify-content:flex-start;gap:8px;margin-bottom:8px">
            <a href="/list" class="btn btn-info">ğŸ“‹ åˆ—è¡¨æ¨¡å¼</a>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{total_count}</div>
                <div class="stat-label">å¾…å®¡é¡¹ç›®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{anonymous_count}</div>
                <div class="stat-label">åŒ¿åæŠ•ç¨¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{with_images_count}</div>
                <div class="stat-label">åŒ…å«å›¾ç‰‡</div>
            </div>
        </div>
        
        <div class="filters">
            <form method="get" action="/" class="filter-row">
                <div class="filter-group">
                    <input type="text" id="search" name="search" class="filter-input" 
                           value="{search}" placeholder="æœç´¢ç”¨æˆ·IDã€æ˜µç§°æˆ–å†…å®¹...">
                </div>
                <button type="submit" class="btn btn-primary" style="background-color: var(--color-primary); color: white;">ğŸ” ç­›é€‰</button>
                <a href="/" class="btn btn-secondary" style="background-color: var(--color-surface-container-high);">ğŸ”„ é‡ç½®</a>
            </form>
        </div>

        <div class="global-controls">
            <h2>å…¨å±€æ“ä½œ</h2>
            <form method="post" action="/api/cmd" class="global-row" id="globalCmdForm">
                <!-- å¼ºåˆ¶ä»¥ä¸»è´¦å·æ‰§è¡Œ -->
                <input type="hidden" name="self_id" value="{main_self_id}">
                <div class="note">ä»¥ä¸»è´¦å·æ‰§è¡Œï¼š{main_self_id}</div>
                <div class="row-1">
                    <button class="btn" name="object" value="å¾…å¤„ç†">ğŸ“‹ å¾…å¤„ç†</button>
                    <button class="btn" name="object" value="å‘é€æš‚å­˜åŒº">ğŸ“¨ å‘é€æš‚å­˜åŒº</button>
                    <button class="btn" name="object" value="åˆ é™¤æš‚å­˜åŒº">ğŸ§¹ åˆ é™¤æš‚å­˜åŒº</button>
                    <button class="btn" name="object" value="åˆ é™¤å¾…å¤„ç†">ğŸ—‘ï¸ åˆ é™¤å¾…å¤„ç†</button>
                </div>
                <div class="row-2">
                    <input class="num-input" type="number" name="number" placeholder="ç¼–å·ï¼ˆè®¾å®š/è°ƒå‡º å…±ç”¨ï¼‰">
                    <button class="btn" name="object" value="è®¾å®šç¼–å·"># è®¾å®šç¼–å·</button>
                    <button class="btn" name="object" value="è°ƒå‡º">ğŸ“¥ è°ƒå‡º</button>
                    <button class="btn btn-info" name="object" value="è‡ªåŠ¨é‡æ–°ç™»å½•">ğŸ” è‡ªåŠ¨é‡æ–°ç™»å½•</button>
                    <button class="btn btn-info" name="object" value="æ‰‹åŠ¨é‡æ–°ç™»å½•">ğŸ”‘ æ‰‹åŠ¨é‡æ–°ç™»å½•</button>
                </div>
            </form>
        </div>
        
        <div class="staging-area">
            <h2>æš‚å­˜åŒºé¢„è§ˆ</h2>
            <div id="staging-grid" class="staging-grid">
                </div>
        </div>
        
        <div class="items-grid">
            {rows}
        </div>
    </div>
    
    <script>
        // ======= Masonryï¼ˆGrid æ¨ªå‘ä¼˜å…ˆå¡«å……ï¼Œç¨³å¥ç‰ˆï¼‰ =======
        (function(){
            function getGrid(){ return document.querySelector('.items-grid'); }
            function rowMetrics(grid){
                const cs = window.getComputedStyle(grid);
                const rowGap = 0; // è¡Œé—´è·å›ºå®šä¸º0ï¼Œç”±å¡ç‰‡marginæä¾›
                let rowH = parseFloat(cs.gridAutoRows);
                if (!rowH || isNaN(rowH)) rowH = 1; // ä½¿ç”¨1pxå•å…ƒå‡å°‘é‡åŒ–è¯¯å·®
                return { rowGap, rowH };
            }
            function measure(card){
                const grid = getGrid(); if (!grid || !card) return;
                const { rowGap, rowH } = rowMetrics(grid);
                const target = card.querySelector('form') || card;
                const h0 = Math.ceil(target.scrollHeight || target.getBoundingClientRect().height);
                const mb = parseFloat(getComputedStyle(card).marginBottom || '0') || 0;
                const h = h0 + mb;
                const span = Math.max(1, Math.ceil(h / rowH));
                card.style.gridRowEnd = 'span ' + span;
            }
            function layoutAll(){
                const grid = getGrid(); if (!grid) return;
                // é¦–å¸§ä½¿ç”¨ auto è¡Œé«˜æ¸²æŸ“çœŸå®é«˜åº¦ï¼Œé¿å…ç»†æ¡
                grid.style.gridAutoRows = 'auto';
                requestAnimationFrame(()=>{
                    grid.querySelectorAll('.item-card').forEach(measure);
                    grid.style.gridAutoRows = '1px';
                });
            }
            function onImgLoad(e){
                const img = e.target; if (!img || img.tagName !== 'IMG') return;
                const card = img.closest('.item-card'); if (!card) return;
                measure(card);
            }
            const mo = new MutationObserver((records)=>{
                for (const r of records){
                    r.addedNodes && r.addedNodes.forEach(node=>{
                        if (node && node.nodeType===1){
                            if (node.classList.contains('item-card')) requestAnimationFrame(()=>measure(node));
                            node.querySelectorAll && node.querySelectorAll('.item-card').forEach(el=>requestAnimationFrame(()=>measure(el)));
                        }
                    });
                }
            });
            let ro;
            try { ro = new ResizeObserver((entries)=>{ for (const e of entries){ if (e.target) measure(e.target); } }); } catch(_){ }
            window.addEventListener('load', ()=>{
                const grid = getGrid();
                if (grid){
                    mo.observe(grid, { childList: true, subtree: true });
                    grid.querySelectorAll('.item-card').forEach(el=> ro && ro.observe(el));
                }
                layoutAll();
                if (document.fonts && document.fonts.ready) document.fonts.ready.then(layoutAll);
            });
            window.addEventListener('resize', ()=>{ clearTimeout(window.__mz_r); window.__mz_r = setTimeout(layoutAll, 150); });
            document.addEventListener('load', onImgLoad, true);
            window._masonry = { measure, layoutAll };
        })();
        // ======= è½»é‡çº§å›¾ç‰‡æµè§ˆå™¨ï¼ˆæ”¯æŒå·¦å³é”®å’Œç§»åŠ¨ç«¯æŒ‰é’®ï¼‰ =======
        (function(){
            let modal=null, imgEl=null, leftBtn=null, rightBtn=null, currentIdx=0, list=[];
            function close(){ if(modal){ modal.remove(); modal=null; list=[]; }}
            function render(){ if(!imgEl) return; imgEl.src=list[currentIdx]; }
            function createButtons(){
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile){
                    leftBtn = document.createElement('button');
                    rightBtn = document.createElement('button');
                    leftBtn.textContent = 'â€¹'; rightBtn.textContent = 'â€º';
                    [leftBtn,rightBtn].forEach(b=>{ b.style.cssText='position:absolute;bottom:12px;background:#21005D;opacity:.9;color:#fff;border:none;border-radius:999px;padding:10px 14px;font-size:18px;pointer-events:auto;'});
                    leftBtn.style.left='12px'; rightBtn.style.right='12px';
                    leftBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx-1+list.length)%list.length; render(); };
                    rightBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx+1)%list.length; render(); };
                    modal.appendChild(leftBtn); modal.appendChild(rightBtn);
                }
            }
            function open(startUrl, urls){
                list = urls.slice(); currentIdx = list.indexOf(startUrl); if(currentIdx<0) currentIdx=0;
                modal = document.createElement('div');
                modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2147483646;cursor:zoom-out;';
                imgEl = document.createElement('img');
                imgEl.style.cssText='max-width:94vw;max-height:94vh;object-fit:contain;border-radius:8px;';
                modal.appendChild(imgEl);
                createButtons();
                document.body.appendChild(modal);
                render();
                modal.onclick=close;
                document.addEventListener('keydown', onKey);
            }
            function onKey(e){
                if(!modal) return;
                if(e.key==='Escape'){ close(); document.removeEventListener('keydown', onKey); return; }
                if(e.key==='ArrowLeft'){ currentIdx=(currentIdx-1+list.length)%list.length; render(); }
                if(e.key==='ArrowRight'){ currentIdx=(currentIdx+1)%list.length; render(); }
            }
            window._openImageBrowser = open;
        })();
        // ======= Toast Manager =======
        (function(){
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.style.position = 'fixed';
            container.style.zIndex = '2147483647';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '8px';
            container.style.pointerEvents = 'none';
            function position(){
                if (window.matchMedia('(max-width: 768px)').matches) {
                    container.style.top = '8px';
                    container.style.bottom = '';
                    container.style.left = '50%';
                    container.style.transform = 'translateX(-50%)';
                    container.style.right = '';
                    container.style.alignItems = 'center';
                } else {
                    container.style.bottom = '12px';
                    container.style.left = '12px';
                    container.style.top = '';
                    container.style.right = '';
                    container.style.transform = '';
                    container.style.alignItems = 'flex-start';
                }
            }
            position();
            window.addEventListener('resize', position);
            document.body.appendChild(container);

            const shown = [];
            function showToast(text, level='info'){
                const el = document.createElement('div');
                el.style.cssText = 'background:#21005D;color:#fff;opacity:.95;padding:10px 12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.25);pointer-events:auto;transition:opacity .4s ease, transform .4s ease;';
                if (level==='success') el.style.background = '#155724';
                if (level==='error') el.style.background = '#b3261e';
                el.textContent = text;
                // æŒ¤å‹ï¼šæœ€å¤š4ä¸ªï¼Œå¤šçš„æ·¡å‡º
                if (shown.length >= 4) {
                    const old = shown.shift();
                    old.style.opacity = '0';
                    setTimeout(()=> old.remove(), 400);
                }
                container.appendChild(el);
                shown.push(el);
                setTimeout(()=>{
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(6px)';
                    setTimeout(()=>{
                        const idx = shown.indexOf(el);
                        if (idx>=0) shown.splice(idx,1);
                        el.remove();
                    }, 400);
                }, 5000);
            }
            // è¿æ¥ SSE
            try{
                const es = new EventSource('/events');
                es.onmessage = (e)=>{
                    try{
                        const data = JSON.parse(e.data);
                        if (data.type==='toast'){
                            showToast(data.text || 'æ“ä½œå®Œæˆ', data.level||'info');
                        } else if (data.type==='new_pending'){
                            // è‡ªåŠ¨æ‹‰å–å¹¶æ’å…¥æ–°å¡ç‰‡
                            const grid = document.querySelector('.items-grid');
                            if (!grid) return;
                            const curMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
                            fetch('/api/pending_tags').then(r=>r.json()).then(async (j)=>{
                                const tags = (j.tags||[]).map(t=>parseInt(t,10)).filter(n=>!isNaN(n));
                                const newTags = tags.filter(n => n > curMax).sort((a,b)=>a-b);
                                if (newTags.length){
                                    for (const t of newTags){
                                        try{
                                            const cr = await fetch('/api/card?tag=' + encodeURIComponent(String(t)));
                                            if (cr.ok){
                                                const d = await cr.json();
                                                const wrap = document.createElement('div');
                                                wrap.innerHTML = d.html;
                                                const card = wrap.firstElementChild;
                                                if (card){
                                                    grid.insertAdjacentElement('afterbegin', card);
                                                    card.classList.add('highlight-new');
                                                    setTimeout(()=> card.classList.remove('highlight-new'), 1500);
                                                }
                                            }
                                        }catch(_){/* ignore */}
                                    }
                                    window._knownMaxTag = Math.max.apply(null, tags);
                                }
                            }).catch(()=>{});
                            showToast('æœ‰æ–°æŠ•ç¨¿åŠ å…¥é˜Ÿåˆ—', 'info');
                        } else if (data.type==='undo'){
                            // å¯é€‰ï¼šæç¤ºæ’¤é”€å®Œæˆ
                            showToast('å·²ä»æš‚å­˜åŒºæ’¤å› #' + data.tag, 'success');
                        } else if (data.type==='processed'){
                            // ç¾¤æŒ‡ä»¤/åå°å¤„ç†å¯¼è‡´çš„é¡¹ç›®çŠ¶æ€å˜æ›´ -> åŒæ­¥æ ‡è®°ä¸ºå·²å¤„ç†
                            const cardInput = document.querySelector('.item-card input[name="tag"][value="' + String(data.tag) + '"]');
                            const card = cardInput ? cardInput.closest('.item-card') : null;
                            if (card) {
                                markProcessed(card);
                            }
                        }
                    }catch(_){/* ignore */}
                };
            }catch(_){/* ignore */}
            // æš´éœ²å…¨å±€ä»¥ä¾¿è°ƒè¯•
            window._toast = showToast;
            window._knownMaxTag = parseInt('{initial_max_tag}', 10) || 0;
        })();
        // ======= æ— åˆ·æ–°æ“ä½œ & æ–°æŠ•ç¨¿æç¤º =======
        function markProcessed(card) {
            card.classList.add('processed');
            const actions = card.querySelector('.item-actions');
            if (actions) {
                // é”å®šå½“å‰æ“ä½œåŒºé«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºâ€œå·²å¤„ç†â€æ—¶é«˜åº¦å˜åŒ–å½±å“å¸ƒå±€
                const prevH = actions.offsetHeight;
                if (prevH > 0) {
                    actions.style.height = prevH + 'px';
                    actions.style.minHeight = prevH + 'px';
                }
                actions.style.display = 'flex';
                actions.style.alignItems = 'center';
                actions.style.justifyContent = 'center';
                actions.style.gap = '0';
                actions.innerHTML = '<div class="btn" style="background:#D4EDDA;color:#155724;min-width:160px;text-align:center">âœ… å·²å¤„ç†</div>';
            }
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[name="cmd"]');
            if (!btn) return;
            const form = btn.closest('form');
            if (!form) return;
            // æ‹¦æˆªé»˜è®¤æäº¤
            e.preventDefault();
            const card = form.closest('.item-card');
            const tag = form.querySelector('input[name="tag"]').value;
            const flag = form.querySelector('textarea[name="flag"]')?.value || '';
            const cmd = btn.value;
            try {
                const res = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ tag, cmd, flag })
                });
                if (res.ok) {
                    if (cmd === 'è¯„è®º') {
                        const ta = form.querySelector('textarea[name="flag"]');
                        if (ta) ta.value = '';
                    } else {
                        markProcessed(card);
                    }
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼ŒçŠ¶æ€ç  ' + res.status);
                }
            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±è´¥ï¼š' + err);
            }
        });

        // é˜²æ­¢å¡ç‰‡è¡¨å•é»˜è®¤æäº¤å¯¼è‡´é¡µé¢è·³åˆ°é¡¶éƒ¨
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (form && form.querySelector('input[name="tag"]')) {
                e.preventDefault();
            }
        });

        // æ–°æŠ•ç¨¿æç¤ºï¼šè½®è¯¢ pending_meta
        (function setupNewPostNotifier(){
            let knownMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
            let toast;
            function showToast(){
                if (toast) return;
                toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#EADDFF;color:#21005D;padding:12px 14px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:2000;display:flex;gap:8px;align-items:center;';
                toast.innerHTML = '<span>æœ‰æ–°æŠ•ç¨¿åŠ å…¥é˜Ÿåˆ—</span>';
                const btn = document.createElement('button');
                btn.textContent = 'åˆ·æ–°åˆ—è¡¨';
                btn.className = 'btn';
                btn.style.background = '#6750A4';
                btn.style.color = '#fff';
                btn.onclick = () => location.reload();
                toast.appendChild(btn);
                document.body.appendChild(toast);
            }
            async function tick(){
                try{
                    const r = await fetch('/api/pending_meta');
                    if(!r.ok) return;
                    const data = await r.json();
                    const maxTag = parseInt(data.max_tag || 0, 10);
                    if (maxTag > knownMax) {
                        knownMax = maxTag;
                        window._knownMaxTag = knownMax;
                        showToast();
                    }
                }catch(err){ console.warn('pending_meta error', err); }
            }
            setInterval(tick, 12000);
        })();
        // å›¾ç‰‡ç‚¹å‡» -> æ‰“å¼€æµè§ˆå™¨
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.item-images')) {
                const imgs = Array.from(e.target.closest('.item-images').querySelectorAll('img')).map(x=>x.src);
                _openImageBrowser(e.target.src, imgs);
            }
        });
        // ç‚¹å‡»æ ‡é¢˜ #tag -> é¢„è§ˆå¼¹çª—ï¼ˆiframeï¼‰
        function openPreview(tag){
            const modal=document.createElement('div');
            modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:2147483646;';
            const frame=document.createElement('iframe');
            frame.src='/detail_html?tag='+encodeURIComponent(tag);
            frame.style.cssText='width:min(92vw, 900px); height:80vh; background:#fff; border-radius:12px; border:1px solid #e5e5ef';
            modal.appendChild(frame);
            modal.onclick=(e)=>{ if(e.target===modal) modal.remove(); };
            document.body.appendChild(modal);
        }
        document.addEventListener('click',(e)=>{
            const tagEl = e.target.closest('.item-tag');
            if(tagEl){
                const form = tagEl.closest('form');
                const tag = form?.querySelector('input[name="tag"]').value;
                if(tag){ e.preventDefault(); openPreview(tag); }
            }
        });
        
        // æ“ä½œæŒ‰é’®ç¡®è®¤
        document.addEventListener('click', (e) => {
            if (e.target.matches('button[name="cmd"][value="åˆ "], button[name="cmd"][value="æ‹’"], button[name="cmd"][value="æ‹‰é»‘"]')) {
                if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    e.preventDefault();
                }
            }
        });

        // æš‚å­˜åŒºè‡ªåŠ¨åˆ·æ–°é€»è¾‘
        function updateStagingArea() {
            fetch('/api/staged')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

                    if (Object.keys(data).length === 0) {
                        grid.innerHTML = '<p style="color: var(--color-on-surface-variant);">æš‚å­˜åŒºæ˜¯ç©ºçš„</p>';
                        return;
                    }

                    for (const groupName in data) {
                        const items = data[groupName];
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'staged-item';
                            // thumbs
                            const th = document.createElement('div');
                            th.className = 'thumbs';
                            const thumbs = Array.isArray(item.thumbs) ? item.thumbs.slice(0,3) : [];
                            thumbs.forEach(fn => {
                                const img = document.createElement('img');
                                const dir = item.img_source_dir || 'prepost';
                                img.src = `/cache/${dir}/${item.tag}/${fn}`;
                                img.alt = `#${item.tag}`;
                                img.loading = 'lazy';
                                th.appendChild(img);
                            });
                            // meta + info
                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            meta.innerHTML = `<span class="group">${groupName}</span> <span class="tag">#${item.tag}</span>`;
                            const undoBtn = document.createElement('button');
                            undoBtn.className = 'btn';
                            undoBtn.textContent = 'â†© æ’¤é”€';
                            undoBtn.onclick = async (ev) => {
                                ev.preventDefault();
                                if (!confirm('ç¡®è®¤å°† #' + item.tag + ' ä»æš‚å­˜åŒºæ’¤å›åˆ°å¾…å¤„ç†ï¼Ÿ')) return;
                                try{
                                    const r = await fetch('/api/staged_undo', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({ tag: String(item.tag) })});
                                    if (r.ok){
                                        // ä»æš‚å­˜åŒºç§»é™¤
                                        div.remove();
                                        // å°è¯•å°†å¡ç‰‡æ’å…¥å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆé‡è¯•å‡ æ¬¡ï¼‰
                                        const grid = document.querySelector('.items-grid');
                                        if (grid) {
                                            let tries = 0;
                                            const tryFetch = async () => {
                                                tries++;
                                                try{
                                                    const cr = await fetch('/api/card?tag=' + encodeURIComponent(item.tag));
                                                    if (cr.ok){
                                                        const data = await cr.json();
                                                        const wrap = document.createElement('div');
                                                        wrap.innerHTML = data.html;
                                                        const card = wrap.firstElementChild;
                                                        if (card){
                                                            grid.insertAdjacentElement('afterbegin', card);
                                                            card.classList.add('highlight-new');
                                                            setTimeout(()=> card.classList.remove('highlight-new'), 1500);
                                                            return;
                                                        }
                                                    }
                                                }catch(_){ }
                                                if (tries < 6) setTimeout(tryFetch, 800);
                                            };
                                            tryFetch();
                                        }
                                    } else {
                                        alert('æ’¤é”€å¤±è´¥ï¼š' + r.status);
                                    }
                                }catch(err){ alert('æ’¤é”€å¤±è´¥ï¼š' + err); }
                            };
                            const undoWrap = document.createElement('div');
                            undoWrap.className = 'undo';
                            undoWrap.appendChild(undoBtn);
                            const info = document.createElement('div');
                            info.className = 'info';
                            const nick = item.nickname || 'æœªçŸ¥';
                            const sender = item.senderid || '';
                            info.textContent = `${nick}${sender ? ' ('+sender+')' : ''}`;
                            // assemble
                            div.appendChild(th);
                            div.appendChild(meta);
                            div.appendChild(info);
                            div.appendChild(undoWrap);
                            grid.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching staged items:', error);
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = '<p style="color: var(--color-error);">åŠ è½½æš‚å­˜åŒºå¤±è´¥</p>';
                });
        }

        // é¡µé¢åŠ è½½æ—¶ç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œä¹‹åæ¯15ç§’åˆ·æ–°ä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', () => {
            updateStagingArea();
            setInterval(updateStagingArea, 15000);
            // å…¨å±€å±é™©åŠ¨ä½œç¡®è®¤
            const form = document.getElementById('globalCmdForm');
            form.addEventListener('click', (e) => {
                if (e.target.name === 'object' && ['åˆ é™¤æš‚å­˜åŒº','åˆ é™¤å¾…å¤„ç†'].includes(e.target.value)) {
                    if (!confirm('ç¡®å®šæ‰§è¡Œâ€œ' + e.target.value + 'â€å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                        e.preventDefault();
                    }
                }
            });
        });
    </script>
</body>
</html>
