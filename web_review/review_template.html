<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OQQWall 审核面板</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. 全局样式与新颜色系统 */
        :root {
            --color-primary: #6750A4;
            --color-primary-container: #EADDFF;
            --color-on-primary-container: #21005D;
            --color-secondary: #625B71;
            --color-error: #B3261E;
            --color-surface-container-lowest: #FFFFFF;
            --color-surface-container-low: #F7F2FA;
            --color-surface-container-high: #ECE6F0;
            --color-surface-container-highest: #E6E0E9;
            --color-on-surface: #1C1B1F;
            --color-on-surface-variant: #49454F;
            --color-outline: #79747E;
            --color-outline-variant: #CAC4D0;
            --shadow-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --shadow-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --shadow-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Roboto", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-surface-container-low);
            color: var(--color-on-surface);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 2. 卡片与布局优化 */
        /* Masonry：CSS Grid + JS 量测（更稳） */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            grid-auto-rows: auto;   /* 首帧用真实高度，量测后切换为 1px 单位行高 */
            grid-auto-flow: dense;
            column-gap: 24px;
            row-gap: 0;             /* 行间距由卡片 margin-bottom 提供，消除量化误差 */
        }

        .item-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            box-shadow: var(--shadow-2);
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0 0 24px;        /* 垂直间距 */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;      /* 供右上角徽章定位 */
        }
        .item-card.processed { opacity: 0.8; }
        .highlight-new { animation: flash 1.5s ease-in-out; }
        @keyframes flash { 0%{box-shadow: 0 0 0 rgba(103,80,164,0);} 50%{box-shadow: 0 0 0 6px rgba(103,80,164,0.25);} 100%{box-shadow: 0 0 0 rgba(103,80,164,0);} }
        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-3);
        }

        .item-content {
            padding: 20px;
            flex-grow: 1;
        }
        
        /* 3. 字体层级优化 */
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
            padding-right: 96px; /* 为右上角徽章预留空间，避免重叠 */
        }

        .item-tag {
            font-size: 24px;
            font-weight: 500;
            color: var(--color-primary);
        }
        
        .info-item {
            font-size: 14px;
            color: var(--color-on-surface-variant);
            margin-top: 4px;
        }
        .info-item strong {
            font-weight: 500;
            color: var(--color-on-surface);
        }

        .item-badges { display:flex; gap:8px; position:absolute; top:10px; right:10px; z-index:2; }
        .badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-anonymous {
            background-color: #F8D7DA;
            color: #721C24;
        }
        .badge-images {
            background-color: #D4EDDA;
            color: #155724;
        }

        /* 4. 优化“白条” -> 融入卡片的设计 */
        .item-comment {
            font-size: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background-color: var(--color-surface-container-low); /* 使用更柔和的背景色 */
            border-radius: 12px;
            border-left: 4px solid var(--color-primary-container);
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }
        .item-sep {
            height: 1px;
            background: var(--color-outline-variant);
            margin: 12px 0 16px 0;
            border-radius: 1px;
        }
        
        /* 5. 图片网格：一行三列，随卡片宽度自适应 */
        .item-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .item-images img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1; /* 保持方形 */
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--color-outline-variant);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .item-images img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-2);
        }

        /* 6. 其他UI元素美化 */
        .comment-form {
            padding: 0px;
            margin: 0 0px;
        }
        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-outline-variant);
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 70px;
            background-color: var(--color-surface-container-low);
        }
        .comment-form textarea:focus {
            outline: 2px solid var(--color-primary);
            border-color: transparent;
        }

        .item-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 1:1:1 三列占满一行 */
            gap: 10px;
            padding: 20px;
            background-color: var(--color-surface-container-high);
            border-radius: 0 0 16px 16px; /* 底部圆角 */
        }
        .item-actions .btn { width: 100%; height: 41px; padding: 0 12px; line-height: 1; }
        /* 操作区按钮：半透明填充 + 2px 实心内边框 */
        .item-actions .btn { 
            background: rgba(202, 196, 208, 0.35); /* 默认淡灰半透明 */
            box-shadow: inset 0 0 0 2px var(--color-outline-variant);
            color: #000; /* 操作区文字统一黑色 */
        }
        .item-actions .btn-success { background: rgba(40, 167, 69, 0.35); box-shadow: inset 0 0 0 2px #28a745; color:#000; }
        .item-actions .btn-warning { background: rgba(255, 193, 7, 0.35); box-shadow: inset 0 0 0 2px #ffc107; color:#000; }
        .item-actions .btn-danger { background: rgba(220, 53, 69, 0.35); box-shadow: inset 0 0 0 2px #dc3545; color:#000; }
        .item-actions .btn-info { background: rgba(23, 162, 184, 0.35); box-shadow: inset 0 0 0 2px #17a2b8; color:#000; }
        
        /* 按钮美化 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-1);
        }
        
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        /* 顶部统计和筛选 */
        .header, .stats, .filters {
            margin-bottom: 24px;
        }

        .header {
            text-align: center;
        }
        h1 {
            font-size: 32px;
            font-weight: 500;
            color: var(--color-on-surface);
        }
        .header p {
            color: var(--color-on-surface-variant);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow-1);
            border: 1px solid var(--color-outline-variant);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--color-on-surface-variant);
        }
        
        .filters {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-1);
        }
        
        .global-controls {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0 24px 0;
            box-shadow: var(--shadow-1);
        }
        .global-controls h2 { font-size: 18px; margin-bottom: 12px; font-weight: 600; }
        .global-row { display:grid; gap: 10px; align-items: center; }
        .global-row .note { grid-column: 1 / -1; color: var(--color-on-surface-variant); }
        .global-row .row-1 { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; }
        .global-row .row-2 { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; }
        /* 统一全局操作区按钮高度（桌面40px，移动端保持60px） */
        .global-controls .btn { height: 40px; padding: 0 18px; line-height: 1; border-radius: 999px; }
        .global-controls .num-input { height: 40px; padding: 0 18px; line-height: 1; border-radius: 999px; }
        /* 超大屏：合并为一行（9列） */
        @media (min-width: 1200px) {
            .global-row { grid-template-columns: repeat(9, auto); }
            .global-row .row-1, .global-row .row-2 { display: contents; }
        }
        /* 移动端：3列布局（恢复按钮高度60px） */
        @media (max-width: 768px) {
            .global-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .global-row .row-1, .global-row .row-2 { display: contents; }
            .global-controls .btn { height: 60px; }
            .global-controls .num-input { height: 60px; }
        }
        .select { padding: 10px 12px; border:1px solid var(--color-outline); border-radius: 12px; }
        .num-input { width: 100%; padding: 10px 16px; border:1px solid var(--color-outline); border-radius: 999px; background: #fff; }
        /* 美化 number 输入的加减按钮 */
        .num-input::-webkit-outer-spin-button,
        .num-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .num-input { -moz-appearance: textfield; }
        
        .filter-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
        }
        
        .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-outline);
            border-radius: 24px;
            font-size: 16px;
        }
        
        .empty-state {
            grid-column: 1 / -1; /* 让空状态占满整行 */
            text-align: center;
            padding: 80px 20px;
        }
        
        /* 暂存区样式 */
        .staging-area {
            background: var(--color-surface-container-high);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-1);
        }
        .staging-area h2 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--color-on-surface-variant);
        }
        .staging-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }
        .staged-item {
            background: var(--color-surface-container-lowest);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            display: grid;
            grid-template-columns: 64px 1fr auto; /* thumbs | text | undo */
            grid-template-rows: auto auto;
            grid-template-areas:
                "thumbs meta undo"
                "thumbs info undo";
            gap: 8px 10px;
            box-shadow: var(--shadow-1);
        }
        .staged-item .thumbs { grid-area: thumbs; display:flex; flex-direction: row; gap:6px; }
        .staged-item .thumbs img { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; border:1px solid var(--color-outline-variant); background:#f6f6f6; }
        .staged-item .tag {
            font-weight: 700;
            color: var(--color-primary);
        }
        .staged-item .group {
            font-size: 12px;
            background: var(--color-primary-container);
            color: var(--color-on-primary-container);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .staged-item .meta { grid-area: meta; display:flex; align-items:center; gap:8px; }
        .staged-item .info { grid-area: info; color: var(--color-on-surface-variant); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .staged-item .undo { grid-area: undo; align-self: start; }
        .staged-item .undo .btn { padding: 6px 10px; font-size: 13px; }

        /* 7. 移动端优化 */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            h1 { font-size: 24px; }
            /* 移动端退化为单列，保留间距 */
            .items-grid { column-count: 1; column-width: auto; column-gap: 0; }
            .item-card { width: 100%; max-width: 100%; overflow: hidden; }
            .item-content { padding: 14px; }
            .item-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .item-tag { font-size: 20px; }
            .item-comment { font-size: 15px; padding: 12px; }
            /* 改为网格布局，自动换行，避免超宽 */
            .item-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; overflow-x: visible; }
            .item-images img { width: 100%; height: auto; aspect-ratio: 1 / 1; }
            /* 操作按钮 3 列布局 */
            .item-actions { padding: 12px; gap: 8px; display: grid; grid-template-columns: repeat(3, 1fr); }
            .item-actions .btn { width: 100%; height: 41px; padding: 0 12px; font-size: 15px; line-height: 1; }
            .btn.btn-info[href^="/detail"] { flex: 1 1 100%; order: -1; }
            .filters { padding: 16px; }
            .filter-row { gap: 10px; }
            .filter-input { font-size: 15px; padding: 10px 14px; }
            .stats { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .stat-number { font-size: 24px; }
            .select, .num-input { max-width: 100%; }
            /* 暂存区：移动端仅显示1张缩略图，横向布局 */
            .staged-item { grid-template-columns: 64px 1fr; grid-template-areas: "thumbs meta" "thumbs info"; }
            .staged-item .thumbs { flex-direction: row; }
            .staged-item .thumbs img:not(:first-child) { display: none; }
        }

    </style>
</head>
<body>
    <div class="container">
        {userbar}
        {notice_html}
        <div class="header">
            <h1>OQQWall 审核面板</h1>
            <p>管理校园墙投稿内容，确保内容质量和社区规范</p>
        </div>
        <div style="display:flex;justify-content:flex-start;gap:8px;margin-bottom:8px">
            <a href="/list" class="btn btn-info">📋 列表模式</a>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{total_count}</div>
                <div class="stat-label">待审项目</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{anonymous_count}</div>
                <div class="stat-label">匿名投稿</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{with_images_count}</div>
                <div class="stat-label">包含图片</div>
            </div>
        </div>
        
        <div class="filters">
            <form method="get" action="/" class="filter-row">
                <div class="filter-group">
                    <input type="text" id="search" name="search" class="filter-input" 
                           value="{search}" placeholder="搜索用户ID、昵称或内容...">
                </div>
                <button type="submit" class="btn btn-primary" style="background-color: var(--color-primary); color: white;">🔍 筛选</button>
                <a href="/" class="btn btn-secondary" style="background-color: var(--color-surface-container-high);">🔄 重置</a>
            </form>
        </div>

        <div class="global-controls">
            <h2>全局操作</h2>
            <form method="post" action="/api/cmd" class="global-row" id="globalCmdForm">
                <!-- 强制以主账号执行 -->
                <input type="hidden" name="self_id" value="{main_self_id}">
                <div class="note">以主账号执行：{main_self_id}</div>
                <div class="row-1">
                    <button class="btn" name="object" value="待处理">📋 待处理</button>
                    <button class="btn" name="object" value="发送暂存区">📨 发送暂存区</button>
                    <button class="btn" name="object" value="删除暂存区">🧹 删除暂存区</button>
                    <button class="btn" name="object" value="删除待处理">🗑️ 删除待处理</button>
                </div>
                <div class="row-2">
                    <input class="num-input" type="number" name="number" placeholder="编号（设定/调出 共用）">
                    <button class="btn" name="object" value="设定编号"># 设定编号</button>
                    <button class="btn" name="object" value="调出">📥 调出</button>
                    <button class="btn btn-info" name="object" value="自动重新登录">🔁 自动重新登录</button>
                    <button class="btn btn-info" name="object" value="手动重新登录">🔑 手动重新登录</button>
                </div>
            </form>
        </div>
        
        <div class="staging-area">
            <h2>暂存区预览</h2>
            <div id="staging-grid" class="staging-grid">
                </div>
        </div>
        
        <div class="items-grid">
            {rows}
        </div>
    </div>
    
    <script>
        // ======= Masonry（Grid 横向优先填充，稳健版） =======
        (function(){
            function getGrid(){ return document.querySelector('.items-grid'); }
            function rowMetrics(grid){
                const cs = window.getComputedStyle(grid);
                const rowGap = 0; // 行间距固定为0，由卡片margin提供
                let rowH = parseFloat(cs.gridAutoRows);
                if (!rowH || isNaN(rowH)) rowH = 1; // 使用1px单元减少量化误差
                return { rowGap, rowH };
            }
            function measure(card){
                const grid = getGrid(); if (!grid || !card) return;
                const { rowGap, rowH } = rowMetrics(grid);
                const target = card.querySelector('form') || card;
                const h0 = Math.ceil(target.scrollHeight || target.getBoundingClientRect().height);
                const mb = parseFloat(getComputedStyle(card).marginBottom || '0') || 0;
                const h = h0 + mb;
                const span = Math.max(1, Math.ceil(h / rowH));
                card.style.gridRowEnd = 'span ' + span;
            }
            function layoutAll(){
                const grid = getGrid(); if (!grid) return;
                // 首帧使用 auto 行高渲染真实高度，避免细条
                grid.style.gridAutoRows = 'auto';
                requestAnimationFrame(()=>{
                    grid.querySelectorAll('.item-card').forEach(measure);
                    grid.style.gridAutoRows = '1px';
                });
            }
            function onImgLoad(e){
                const img = e.target; if (!img || img.tagName !== 'IMG') return;
                const card = img.closest('.item-card'); if (!card) return;
                measure(card);
            }
            const mo = new MutationObserver((records)=>{
                for (const r of records){
                    r.addedNodes && r.addedNodes.forEach(node=>{
                        if (node && node.nodeType===1){
                            if (node.classList.contains('item-card')) requestAnimationFrame(()=>measure(node));
                            node.querySelectorAll && node.querySelectorAll('.item-card').forEach(el=>requestAnimationFrame(()=>measure(el)));
                        }
                    });
                }
            });
            let ro;
            try { ro = new ResizeObserver((entries)=>{ for (const e of entries){ if (e.target) measure(e.target); } }); } catch(_){ }
            window.addEventListener('load', ()=>{
                const grid = getGrid();
                if (grid){
                    mo.observe(grid, { childList: true, subtree: true });
                    grid.querySelectorAll('.item-card').forEach(el=> ro && ro.observe(el));
                }
                layoutAll();
                if (document.fonts && document.fonts.ready) document.fonts.ready.then(layoutAll);
            });
            window.addEventListener('resize', ()=>{ clearTimeout(window.__mz_r); window.__mz_r = setTimeout(layoutAll, 150); });
            document.addEventListener('load', onImgLoad, true);
            window._masonry = { measure, layoutAll };
        })();
        // ======= 轻量级图片浏览器（支持左右键和移动端按钮） =======
        (function(){
            let modal=null, imgEl=null, leftBtn=null, rightBtn=null, currentIdx=0, list=[];
            function close(){ if(modal){ modal.remove(); modal=null; list=[]; }}
            function render(){ if(!imgEl) return; imgEl.src=list[currentIdx]; }
            function createButtons(){
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile){
                    leftBtn = document.createElement('button');
                    rightBtn = document.createElement('button');
                    leftBtn.textContent = '‹'; rightBtn.textContent = '›';
                    [leftBtn,rightBtn].forEach(b=>{ b.style.cssText='position:absolute;bottom:12px;background:#21005D;opacity:.9;color:#fff;border:none;border-radius:999px;padding:10px 14px;font-size:18px;pointer-events:auto;'});
                    leftBtn.style.left='12px'; rightBtn.style.right='12px';
                    leftBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx-1+list.length)%list.length; render(); };
                    rightBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx+1)%list.length; render(); };
                    modal.appendChild(leftBtn); modal.appendChild(rightBtn);
                }
            }
            function open(startUrl, urls){
                list = urls.slice(); currentIdx = list.indexOf(startUrl); if(currentIdx<0) currentIdx=0;
                modal = document.createElement('div');
                modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2147483646;cursor:zoom-out;';
                imgEl = document.createElement('img');
                imgEl.style.cssText='max-width:94vw;max-height:94vh;object-fit:contain;border-radius:8px;';
                modal.appendChild(imgEl);
                createButtons();
                document.body.appendChild(modal);
                render();
                modal.onclick=close;
                document.addEventListener('keydown', onKey);
            }
            function onKey(e){
                if(!modal) return;
                if(e.key==='Escape'){ close(); document.removeEventListener('keydown', onKey); return; }
                if(e.key==='ArrowLeft'){ currentIdx=(currentIdx-1+list.length)%list.length; render(); }
                if(e.key==='ArrowRight'){ currentIdx=(currentIdx+1)%list.length; render(); }
            }
            window._openImageBrowser = open;
        })();
        // ======= Toast Manager =======
        (function(){
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.style.position = 'fixed';
            container.style.zIndex = '2147483647';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '8px';
            container.style.pointerEvents = 'none';
            function position(){
                if (window.matchMedia('(max-width: 768px)').matches) {
                    container.style.top = '8px';
                    container.style.bottom = '';
                    container.style.left = '50%';
                    container.style.transform = 'translateX(-50%)';
                    container.style.right = '';
                    container.style.alignItems = 'center';
                } else {
                    container.style.bottom = '12px';
                    container.style.left = '12px';
                    container.style.top = '';
                    container.style.right = '';
                    container.style.transform = '';
                    container.style.alignItems = 'flex-start';
                }
            }
            position();
            window.addEventListener('resize', position);
            document.body.appendChild(container);

            const shown = [];
            function showToast(text, level='info'){
                const el = document.createElement('div');
                el.style.cssText = 'background:#21005D;color:#fff;opacity:.95;padding:10px 12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.25);pointer-events:auto;transition:opacity .4s ease, transform .4s ease;';
                if (level==='success') el.style.background = '#155724';
                if (level==='error') el.style.background = '#b3261e';
                el.textContent = text;
                // 挤压：最多4个，多的淡出
                if (shown.length >= 4) {
                    const old = shown.shift();
                    old.style.opacity = '0';
                    setTimeout(()=> old.remove(), 400);
                }
                container.appendChild(el);
                shown.push(el);
                setTimeout(()=>{
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(6px)';
                    setTimeout(()=>{
                        const idx = shown.indexOf(el);
                        if (idx>=0) shown.splice(idx,1);
                        el.remove();
                    }, 400);
                }, 5000);
            }
            // 连接 SSE
            try{
                const es = new EventSource('/events');
                es.onmessage = (e)=>{
                    try{
                        const data = JSON.parse(e.data);
                        if (data.type==='toast'){
                            showToast(data.text || '操作完成', data.level||'info');
                        } else if (data.type==='new_pending'){
                            // 自动拉取并插入新卡片
                            const grid = document.querySelector('.items-grid');
                            if (!grid) return;
                            const curMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
                            fetch('/api/pending_tags').then(r=>r.json()).then(async (j)=>{
                                const tags = (j.tags||[]).map(t=>parseInt(t,10)).filter(n=>!isNaN(n));
                                const newTags = tags.filter(n => n > curMax).sort((a,b)=>a-b);
                                if (newTags.length){
                                    for (const t of newTags){
                                        try{
                                            const cr = await fetch('/api/card?tag=' + encodeURIComponent(String(t)));
                                            if (cr.ok){
                                                const d = await cr.json();
                                                const wrap = document.createElement('div');
                                                wrap.innerHTML = d.html;
                                                const card = wrap.firstElementChild;
                                                if (card){
                                                    grid.insertAdjacentElement('afterbegin', card);
                                                    card.classList.add('highlight-new');
                                                    setTimeout(()=> card.classList.remove('highlight-new'), 1500);
                                                }
                                            }
                                        }catch(_){/* ignore */}
                                    }
                                    window._knownMaxTag = Math.max.apply(null, tags);
                                }
                            }).catch(()=>{});
                            showToast('有新投稿加入队列', 'info');
                        } else if (data.type==='undo'){
                            // 可选：提示撤销完成
                            showToast('已从暂存区撤回 #' + data.tag, 'success');
                        } else if (data.type==='processed'){
                            // 群指令/后台处理导致的项目状态变更 -> 同步标记为已处理
                            const cardInput = document.querySelector('.item-card input[name="tag"][value="' + String(data.tag) + '"]');
                            const card = cardInput ? cardInput.closest('.item-card') : null;
                            if (card) {
                                markProcessed(card);
                            }
                        }
                    }catch(_){/* ignore */}
                };
            }catch(_){/* ignore */}
            // 暴露全局以便调试
            window._toast = showToast;
            window._knownMaxTag = parseInt('{initial_max_tag}', 10) || 0;
        })();
        // ======= 无刷新操作 & 新投稿提示 =======
        function markProcessed(card) {
            card.classList.add('processed');
            const actions = card.querySelector('.item-actions');
            if (actions) {
                // 锁定当前操作区高度，避免显示“已处理”时高度变化影响布局
                const prevH = actions.offsetHeight;
                if (prevH > 0) {
                    actions.style.height = prevH + 'px';
                    actions.style.minHeight = prevH + 'px';
                }
                actions.style.display = 'flex';
                actions.style.alignItems = 'center';
                actions.style.justifyContent = 'center';
                actions.style.gap = '0';
                actions.innerHTML = '<div class="btn" style="background:#D4EDDA;color:#155724;min-width:160px;text-align:center">✅ 已处理</div>';
            }
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[name="cmd"]');
            if (!btn) return;
            const form = btn.closest('form');
            if (!form) return;
            // 拦截默认提交
            e.preventDefault();
            const card = form.closest('.item-card');
            const tag = form.querySelector('input[name="tag"]').value;
            const flag = form.querySelector('textarea[name="flag"]')?.value || '';
            const cmd = btn.value;
            try {
                const res = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ tag, cmd, flag })
                });
                if (res.ok) {
                    if (cmd === '评论') {
                        const ta = form.querySelector('textarea[name="flag"]');
                        if (ta) ta.value = '';
                    } else {
                        markProcessed(card);
                    }
                } else {
                    alert('操作失败，状态码 ' + res.status);
                }
            } catch (err) {
                console.error(err);
                alert('操作失败：' + err);
            }
        });

        // 防止卡片表单默认提交导致页面跳到顶部
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (form && form.querySelector('input[name="tag"]')) {
                e.preventDefault();
            }
        });

        // 新投稿提示：轮询 pending_meta
        (function setupNewPostNotifier(){
            let knownMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
            let toast;
            function showToast(){
                if (toast) return;
                toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#EADDFF;color:#21005D;padding:12px 14px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:2000;display:flex;gap:8px;align-items:center;';
                toast.innerHTML = '<span>有新投稿加入队列</span>';
                const btn = document.createElement('button');
                btn.textContent = '刷新列表';
                btn.className = 'btn';
                btn.style.background = '#6750A4';
                btn.style.color = '#fff';
                btn.onclick = () => location.reload();
                toast.appendChild(btn);
                document.body.appendChild(toast);
            }
            async function tick(){
                try{
                    const r = await fetch('/api/pending_meta');
                    if(!r.ok) return;
                    const data = await r.json();
                    const maxTag = parseInt(data.max_tag || 0, 10);
                    if (maxTag > knownMax) {
                        knownMax = maxTag;
                        window._knownMaxTag = knownMax;
                        showToast();
                    }
                }catch(err){ console.warn('pending_meta error', err); }
            }
            setInterval(tick, 12000);
        })();
        // 图片点击 -> 打开浏览器
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.item-images')) {
                const imgs = Array.from(e.target.closest('.item-images').querySelectorAll('img')).map(x=>x.src);
                _openImageBrowser(e.target.src, imgs);
            }
        });
        // 点击标题 #tag -> 预览弹窗（iframe）
        function openPreview(tag){
            const modal=document.createElement('div');
            modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:2147483646;';
            const frame=document.createElement('iframe');
            frame.src='/detail_html?tag='+encodeURIComponent(tag);
            frame.style.cssText='width:min(92vw, 900px); height:80vh; background:#fff; border-radius:12px; border:1px solid #e5e5ef';
            modal.appendChild(frame);
            modal.onclick=(e)=>{ if(e.target===modal) modal.remove(); };
            document.body.appendChild(modal);
        }
        document.addEventListener('click',(e)=>{
            const tagEl = e.target.closest('.item-tag');
            if(tagEl){
                const form = tagEl.closest('form');
                const tag = form?.querySelector('input[name="tag"]').value;
                if(tag){ e.preventDefault(); openPreview(tag); }
            }
        });
        
        // 操作按钮确认
        document.addEventListener('click', (e) => {
            if (e.target.matches('button[name="cmd"][value="删"], button[name="cmd"][value="拒"], button[name="cmd"][value="拉黑"]')) {
                if (!confirm('确定要执行此操作吗？此操作不可撤销！')) {
                    e.preventDefault();
                }
            }
        });

        // 暂存区自动刷新逻辑
        function updateStagingArea() {
            fetch('/api/staged')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = ''; // 清空现有内容

                    if (Object.keys(data).length === 0) {
                        grid.innerHTML = '<p style="color: var(--color-on-surface-variant);">暂存区是空的</p>';
                        return;
                    }

                    for (const groupName in data) {
                        const items = data[groupName];
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'staged-item';
                            // thumbs
                            const th = document.createElement('div');
                            th.className = 'thumbs';
                            const thumbs = Array.isArray(item.thumbs) ? item.thumbs.slice(0,3) : [];
                            thumbs.forEach(fn => {
                                const img = document.createElement('img');
                                const dir = item.img_source_dir || 'prepost';
                                img.src = `/cache/${dir}/${item.tag}/${fn}`;
                                img.alt = `#${item.tag}`;
                                img.loading = 'lazy';
                                th.appendChild(img);
                            });
                            // meta + info
                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            meta.innerHTML = `<span class="group">${groupName}</span> <span class="tag">#${item.tag}</span>`;
                            const undoBtn = document.createElement('button');
                            undoBtn.className = 'btn';
                            undoBtn.textContent = '↩ 撤销';
                            undoBtn.onclick = async (ev) => {
                                ev.preventDefault();
                                if (!confirm('确认将 #' + item.tag + ' 从暂存区撤回到待处理？')) return;
                                try{
                                    const r = await fetch('/api/staged_undo', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({ tag: String(item.tag) })});
                                    if (r.ok){
                                        // 从暂存区移除
                                        div.remove();
                                        // 尝试将卡片插入待审核列表（重试几次）
                                        const grid = document.querySelector('.items-grid');
                                        if (grid) {
                                            let tries = 0;
                                            const tryFetch = async () => {
                                                tries++;
                                                try{
                                                    const cr = await fetch('/api/card?tag=' + encodeURIComponent(item.tag));
                                                    if (cr.ok){
                                                        const data = await cr.json();
                                                        const wrap = document.createElement('div');
                                                        wrap.innerHTML = data.html;
                                                        const card = wrap.firstElementChild;
                                                        if (card){
                                                            grid.insertAdjacentElement('afterbegin', card);
                                                            card.classList.add('highlight-new');
                                                            setTimeout(()=> card.classList.remove('highlight-new'), 1500);
                                                            return;
                                                        }
                                                    }
                                                }catch(_){ }
                                                if (tries < 6) setTimeout(tryFetch, 800);
                                            };
                                            tryFetch();
                                        }
                                    } else {
                                        alert('撤销失败：' + r.status);
                                    }
                                }catch(err){ alert('撤销失败：' + err); }
                            };
                            const undoWrap = document.createElement('div');
                            undoWrap.className = 'undo';
                            undoWrap.appendChild(undoBtn);
                            const info = document.createElement('div');
                            info.className = 'info';
                            const nick = item.nickname || '未知';
                            const sender = item.senderid || '';
                            info.textContent = `${nick}${sender ? ' ('+sender+')' : ''}`;
                            // assemble
                            div.appendChild(th);
                            div.appendChild(meta);
                            div.appendChild(info);
                            div.appendChild(undoWrap);
                            grid.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching staged items:', error);
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = '<p style="color: var(--color-error);">加载暂存区失败</p>';
                });
        }

        // 页面加载时第一次更新，之后每15秒刷新一次
        document.addEventListener('DOMContentLoaded', () => {
            updateStagingArea();
            setInterval(updateStagingArea, 15000);
            // 全局危险动作确认
            const form = document.getElementById('globalCmdForm');
            form.addEventListener('click', (e) => {
                if (e.target.name === 'object' && ['删除暂存区','删除待处理'].includes(e.target.value)) {
                    if (!confirm('确定执行“' + e.target.value + '”吗？该操作不可撤销。')) {
                        e.preventDefault();
                    }
                }
            });
        });
    </script>
</body>
</html>
