<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#6750A4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <title>OQQWall å®¡æ ¸é¢æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 1. å…¨å±€æ ·å¼ä¸æ–°é¢œè‰²ç³»ç»Ÿ */
        :root {
            --color-primary: #6750A4;
            --color-primary-container: #EADDFF;
            --color-on-primary-container: #21005D;
            --color-secondary: #625B71;
            --color-error: #B3261E;
            --color-surface-container-lowest: #FFFFFF;
            --color-surface-container-low: #F7F2FA;
            --color-surface-container-high: #ECE6F0;
            --color-surface-container-highest: #E6E0E9;
            --color-on-surface: #1C1B1F;
            --color-on-surface-variant: #49454F;
            --color-outline: #79747E;
            --color-outline-variant: #CAC4D0;
            --shadow-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --shadow-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --shadow-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Roboto", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-surface-container-low);
            color: var(--color-on-surface);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* 2. å¡ç‰‡ä¸å¸ƒå±€ä¼˜åŒ– */
        /* Masonryï¼šCSS Grid + JS é‡æµ‹ï¼ˆæ›´ç¨³ï¼‰ */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            grid-auto-rows: auto;
            /* é¦–å¸§ç”¨çœŸå®é«˜åº¦ï¼Œé‡æµ‹ååˆ‡æ¢ä¸º 1px å•ä½è¡Œé«˜ */
            grid-auto-flow: dense;
            column-gap: 24px;
            row-gap: 0;
            /* è¡Œé—´è·ç”±å¡ç‰‡ margin-bottom æä¾›ï¼Œæ¶ˆé™¤é‡åŒ–è¯¯å·® */
        }

        .item-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            box-shadow: var(--shadow-2);
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0 0 24px;
            /* å‚ç›´é—´è· */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            /* ä¾›å³ä¸Šè§’å¾½ç« å®šä½ */
        }

        .item-card.processed {
            opacity: 0.8;
        }

        .highlight-new {
            animation: flash 1.5s ease-in-out;
        }

        @keyframes flash {
            0% {
                box-shadow: 0 0 0 rgba(103, 80, 164, 0);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(103, 80, 164, 0.25);
            }

            100% {
                box-shadow: 0 0 0 rgba(103, 80, 164, 0);
            }
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-3);
        }

        .item-content {
            padding: 20px;
            flex-grow: 1;
        }

        /* 3. å­—ä½“å±‚çº§ä¼˜åŒ– */
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
            padding-right: 96px;
            /* ä¸ºå³ä¸Šè§’å¾½ç« é¢„ç•™ç©ºé—´ï¼Œé¿å…é‡å  */
        }

        .item-tag {
            font-size: 24px;
            font-weight: 500;
            color: var(--color-primary);
        }

        .info-item {
            font-size: 14px;
            color: var(--color-on-surface-variant);
            margin-top: 4px;
        }

        .info-item strong {
            font-weight: 500;
            color: var(--color-on-surface);
        }

        .item-badges {
            display: flex;
            gap: 8px;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge-anonymous {
            background-color: #F8D7DA;
            color: #721C24;
        }

        .badge-images {
            background-color: #D4EDDA;
            color: #155724;
        }

        /* 4. ä¼˜åŒ–â€œç™½æ¡â€ -> èå…¥å¡ç‰‡çš„è®¾è®¡ */
        .item-comment {
            font-size: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background-color: var(--color-surface-container-low);
            /* ä½¿ç”¨æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
            border-radius: 12px;
            border-left: 4px solid var(--color-primary-container);
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }

        .item-sep {
            height: 1px;
            background: var(--color-outline-variant);
            margin: 12px 0 16px 0;
            border-radius: 1px;
        }

        /* 5. å›¾ç‰‡ç½‘æ ¼ï¼šè‡ªé€‚åº”æ•°é‡ï¼Œé¿å…ä¸badgeé‡å  */
        .item-images {
            display: grid;
            grid-template-columns: repeat(var(--img-cols, 3), 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .item-images img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            /* ä¿æŒæ–¹å½¢ */
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--color-outline-variant);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .item-images img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-2);
        }

        /* 6. å…¶ä»–UIå…ƒç´ ç¾åŒ– */
        .comment-form {
            padding: 0px;
            margin: 0 0px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-outline-variant);
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 70px;
            background-color: var(--color-surface-container-low);
        }

        .comment-form textarea:focus {
            outline: 2px solid var(--color-primary);
            border-color: transparent;
        }

        .item-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* 1:1:1 ä¸‰åˆ—å æ»¡ä¸€è¡Œ */
            gap: 10px;
            padding: 20px;
            background-color: var(--color-surface-container-high);
            border-radius: 0 0 16px 16px;
            /* åº•éƒ¨åœ†è§’ */
        }

        .item-actions .btn {
            width: 100%;
            height: 41px;
            padding: 0 12px;
            line-height: 1;
        }

        /* æ“ä½œåŒºæŒ‰é’®ï¼šåŠé€æ˜å¡«å…… + 2px å®å¿ƒå†…è¾¹æ¡† */
        .item-actions .btn {
            background: rgba(202, 196, 208, 0.35);
            /* é»˜è®¤æ·¡ç°åŠé€æ˜ */
            box-shadow: inset 0 0 0 2px var(--color-outline-variant);
            color: #000;
            /* æ“ä½œåŒºæ–‡å­—ç»Ÿä¸€é»‘è‰² */
        }

        .item-actions .btn-success {
            background: rgba(40, 167, 69, 0.35);
            box-shadow: inset 0 0 0 2px #28a745;
            color: #000;
        }

        .item-actions .btn-warning {
            background: rgba(255, 193, 7, 0.35);
            box-shadow: inset 0 0 0 2px #ffc107;
            color: #000;
        }

        .item-actions .btn-danger {
            background: rgba(220, 53, 69, 0.35);
            box-shadow: inset 0 0 0 2px #dc3545;
            color: #000;
        }

        .item-actions .btn-info {
            background: rgba(23, 162, 184, 0.35);
            box-shadow: inset 0 0 0 2px #17a2b8;
            color: #000;
        }

        /* æŒ‰é’®ç¾åŒ– */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-1);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* é¡¶éƒ¨ç»Ÿè®¡å’Œç­›é€‰ */

        .header {
            text-align: center;
        }

        h1 {
            font-size: 32px;
            font-weight: 500;
            color: var(--color-on-surface);
        }

        .header p {
            color: var(--color-on-surface-variant);
        }

        .stats {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 120px;
        }

        .stat-card {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--shadow-1);
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-number {
            font-size: clamp(8px, 4vw, 32px);
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-on-surface-variant);
        }

        .filters {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-1);
            margin: 0px 16px;
            width: 100%
        }

        .global-controls {
            background: var(--color-surface-container-lowest);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-1);
            width: 100%;
        }

        .global-controls h2 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .global-row {
            display: grid;
            gap: 10px;
            align-items: center;
        }

        .global-row .note {
            grid-column: 1 / -1;
            color: var(--color-on-surface-variant);
        }

        .global-row .row-1 {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .global-row .row-2 {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
        }

        /* ç»Ÿä¸€å…¨å±€æ“ä½œåŒºæŒ‰é’®é«˜åº¦ï¼ˆæ¡Œé¢40pxï¼Œç§»åŠ¨ç«¯ä¿æŒ60pxï¼‰ï¼›å›¾æ ‡ä¸æ–‡æœ¬åˆ†ç¦» */
        .global-controls .btn {
            height: 40px;
            padding: 0 12px;
            line-height: 1.2;
            border-radius: 999px;
            white-space: nowrap;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .global-controls .btn .ico {
            flex: 0 0 auto;
        }

        .global-controls .btn .label,
        .global-controls .btn .text {
            display: inline-block;
        }

        .global-controls .num-input {
            height: 40px;
            padding: 0 18px;
            line-height: 1;
            border-radius: 999px;
        }

        /* å…¨å±€æŒ‰é’®æ–‡æœ¬æŒ‰è¯æ¢è¡Œï¼ˆä¸æŒ‰å­—æ–­è¡Œï¼‰ï¼Œæœ€å¤šä¸¤è¡Œ */
        .global-btn {
            white-space: normal;
            word-break: keep-all;
            /* é¿å…åœ¨å•è¯/æ±‰å­—ä¸­é—´æ–­è¡Œ */
            overflow-wrap: break-word;
            /* ä»…åœ¨å¿…è¦æ—¶å¯¹è¶…é•¿è‹±æ–‡å•è¯æ–­è¡Œ */
            display: -webkit-box !important;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* æ”¯æŒæµè§ˆå™¨å¯ç”¨ä¸­æ–‡â€œæŒ‰è¯è¯­â€åˆ†è¡Œï¼ˆChrome/Safari è¿‘ç‰ˆæœ¬æ”¯æŒï¼‰ */
        @supports (word-break: auto-phrase) {

            .global-btn,
            .global-controls .btn .label,
            .global-controls .btn .text {
                word-break: auto-phrase;
            }
        }

        /* è¶…å¤§å±ï¼šåˆå¹¶ä¸ºä¸€è¡Œï¼ˆ9åˆ—ï¼‰ - ä»…åœ¨ â‰¥1300px */
        @media (min-width: 1300px) {
            .global-row {
                grid-template-columns: repeat(9, minmax(0, 1fr));
            }

            .global-row .row-1,
            .global-row .row-2 {
                display: contents;
            }
        }

        /* <1300px å¼ºåˆ¶ä½¿ç”¨ä¸¤è¡Œå¸ƒå±€ï¼š4åˆ— + 5åˆ—ï¼ˆé»˜è®¤å·²å®šä¹‰ï¼‰ */
        /* ç§»åŠ¨ç‰ˆï¼ˆ<550pxï¼‰ï¼šå›ºå®šä¸‰åˆ—æ …æ ¼ï¼Œå½¢æˆ 3+3+3 */
        @media (max-width: 550px) {
            .global-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .global-row .row-1,
            .global-row .row-2 {
                display: contents;
            }

            /* æŒ‰é’®å…è®¸æ¢è¡Œï¼Œæœ€å¤šä¸¤è¡Œï¼ˆä»…æ–‡æœ¬éƒ¨åˆ†è£åˆ‡ï¼‰ï¼›å›¾æ ‡ä¸æ–‡æœ¬å·¦å³åˆ†æ  */
            .global-controls .btn {
                height: 60px;
                white-space: normal;
                display: grid !important;
                grid-template-columns: auto 1fr;
                align-items: center;
                column-gap: 8px;
            }

            .global-controls .btn .label,
            .global-controls .btn .text {
                display: -webkit-box !important;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                word-break: keep-all;
                /* æŒ‰è¯æ¢è¡Œ */
                overflow-wrap: break-word;
                /* è‹±æ–‡é•¿è¯å¿…è¦æ—¶æ–­è¡Œ */
            }

            .global-controls .btn .ico {
                grid-column: 1;
            }

            .global-controls .btn .label,
            .global-controls .btn .text {
                grid-column: 2;
            }

            /* ç¼–å·è¾“å…¥ï¼šå®½åº¦ä¸é™åˆ¶ï¼Œå…è®¸éšæ …æ ¼ä¼¸ç¼© */
            .global-controls .num-input {
                height: 60px;
                min-width: 0;
                width: 100%;
            }
        }

        .select {
            padding: 10px 12px;
            border: 1px solid var(--color-outline);
            border-radius: 12px;
        }

        .num-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--color-outline);
            border-radius: 999px;
            background: #fff;
        }

        /* ç¾åŒ– number è¾“å…¥çš„åŠ å‡æŒ‰é’® */
        .num-input::-webkit-outer-spin-button,
        .num-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .num-input {
            -moz-appearance: textfield;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
        }

        .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-outline);
            border-radius: 24px;
            font-size: 16px;
        }

        .empty-state {
            grid-column: 1 / -1;
            /* è®©ç©ºçŠ¶æ€å æ»¡æ•´è¡Œ */
            text-align: center;
            padding: 80px 20px;
        }

        /* æš‚å­˜åŒºæ ·å¼ï¼ˆä¸åˆ—è¡¨é¡µä¸€è‡´ï¼‰ */
        .staging-area {
            background: #ECE6F0;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
        }

        .staging-area h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #49454F;
        }

        .staging-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .staged-item {
            background: #fff;
            border-radius: 12px;
            padding: 10px;
            font-size: 14px;
            display: grid;
            grid-template-columns: 64px 1fr auto;
            /* thumbs | text | undo */
            grid-template-rows: auto auto;
            grid-template-areas:
                "thumbs meta undo"
                "thumbs info undo";
            gap: 8px 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .08);
        }

        .staged-item .thumbs {
            grid-area: thumbs;
            display: flex;
            flex-direction: row;
            gap: 6px;
        }

        .staged-item .thumbs img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--color-outline-variant);
            background: #f6f6f6;
        }

        .staged-item .tag {
            font-weight: 700;
            color: var(--color-primary);
        }

        .staged-item .group {
            font-size: 12px;
            background: var(--color-primary-container);
            color: var(--color-on-primary-container);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .staged-item .meta {
            grid-area: meta;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .staged-item .info {
            grid-area: info;
            color: var(--color-on-surface-variant);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .staged-item .undo {
            grid-area: undo;
            align-self: center;
            justify-self: end;
        }

        .staged-item .undo .btn {
            padding: 6px 10px;
            font-size: 13px;
        }

        .sep {
            height: auto;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 16px;
            margin: 12px 0 16px 0;
            width: 100%;
        }

        .top-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            flex: 1 1 auto;
            min-width: 0;
            width: 100%;
        }

        /* 7. ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 24px;
            }

            /* ç§»åŠ¨ç«¯é€€åŒ–ä¸ºå•åˆ—ï¼Œä¿ç•™é—´è· */
            .items-grid {
                column-count: 1;
                column-width: auto;
                column-gap: 0;
            }

            .item-card {
                width: 100%;
                max-width: 100%;
                overflow: hidden;
            }

            .item-content {
                padding: 14px;
            }

            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .item-tag {
                font-size: 20px;
            }

            .item-comment {
                font-size: 15px;
                padding: 12px;
            }

            /* æ”¹ä¸ºç½‘æ ¼å¸ƒå±€ï¼Œè‡ªåŠ¨æ¢è¡Œï¼Œé¿å…è¶…å®½ */
            .item-images {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 12px;
                overflow-x: visible;
            }

            .item-images img {
                width: 100%;
                height: auto;
                aspect-ratio: 1 / 1;
            }

            /* æ“ä½œæŒ‰é’® 3 åˆ—å¸ƒå±€ */
            .item-actions {
                padding: 12px;
                gap: 8px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
            }

            .item-actions .btn {
                width: 100%;
                height: 41px;
                padding: 0 12px;
                font-size: 15px;
                line-height: 1;
            }

            .btn.btn-info[href^="/detail"] {
                flex: 1 1 100%;
                order: -1;
            }

            .filters {
                padding: 16px;
            }

            .filter-row {
                gap: 10px;
            }

            .filter-input {
                font-size: 15px;
                padding: 10px 14px;
            }

            .stats {
                display: none !important;
                /* æ‰‹æœºç«¯éšè—ç»Ÿè®¡åŒº */
            }

            .stat-number {
                font-size: clamp(8px, 6vw, 32px);
            }

            .select,
            .num-input {
                max-width: 100%;
            }

            /* æš‚å­˜åŒºï¼šç§»åŠ¨ç«¯ä»…æ˜¾ç¤º1å¼ ç¼©ç•¥å›¾ï¼Œæ¨ªå‘å¸ƒå±€ */
            .staged-item {
                grid-template-columns: 64px 1fr;
                grid-template-areas: "thumbs meta" "thumbs info";
            }

            .staged-item .thumbs {
                flex-direction: row;
            }

            .staged-item .thumbs img:not(:first-child) {
                display: none;
            }
        }
    </style>
</head>

    <body>
        <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{});});}</script>
        <script>
            // åç«¯æ³¨å…¥çš„é…ç½®å˜é‡
            // - HIDE_STAGING: è‹¥ä¸º true åˆ™å®Œå…¨éšè—æš‚å­˜åŒº
            // - IMG_BASE: å›¾ç‰‡ç›´é“¾å‰ç¼€ï¼ˆä¾‹å¦‚ http://host:port/i æˆ–è€… /iï¼‰
            window.HIDE_STAGING = {hide_staging};
            window.IMG_BASE = "{img_base}";
        </script>
        <script>
            // PWA å®‰è£…æŒ‰é’®ï¼ˆæ”¯æŒ HTTPSã€localhostï¼Œä»¥åŠ HTTP ä¸‹çš„æ‰‹åŠ¨æ·»åŠ å¼•å¯¼ï¼‰
            (function(){
                let deferredPrompt = null;
                const ua = navigator.userAgent || '';
                const isIOS = /iphone|ipad|ipod/i.test(ua);
                const isAndroid = /android/i.test(ua);
                const isSecure = (window.isSecureContext === true) || location.protocol === 'https:' || /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
                function installed(){
                  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
                }
                function btnEl(){ return document.getElementById('installBtn'); }
                function show(){ const b=btnEl(); if(b && !installed()) b.style.display=''; }
                function hide(){ const b=btnEl(); if(b) b.style.display='none'; }
                function showHelpModal(){
                  const modal=document.createElement('div');
                  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2147483647;';
                  const box=document.createElement('div');
                  box.style.cssText='background:#fff;max-width:520px;width:92vw;border-radius:12px;padding:16px;';
                  const h=document.createElement('h3'); h.textContent='å®‰è£…åˆ°ä¸»å±å¹•'; h.style.margin='0 0 8px 0';
                  const p=document.createElement('div'); p.style.cssText='color:#49454F;line-height:1.6;font-size:14px';
                  if (isIOS){
                    p.innerHTML='åœ¨ Safari ä¸­ï¼Œç‚¹å‡»åº•éƒ¨â€œåˆ†äº«â€æŒ‰é’®ï¼Œç„¶åé€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚';
                  } else if (isAndroid){
                    p.innerHTML='åœ¨æµè§ˆå™¨èœå•ä¸­é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€æˆ–â€œå®‰è£…åº”ç”¨â€ã€‚ä¸åŒæµè§ˆå™¨ä½ç½®ç•¥æœ‰å·®å¼‚ã€‚';
                  } else {
                    p.innerHTML='è¯·åœ¨æµè§ˆå™¨èœå•ä¸­æŸ¥æ‰¾â€œå®‰è£…ç«™ç‚¹â€æˆ–â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚è‹¥ä¸å¯ç”¨ï¼Œè¯·åœ¨ HTTPS æˆ– localhost ç¯å¢ƒè®¿é—®ä»¥å¯ç”¨è‡ªåŠ¨å®‰è£…æç¤ºã€‚';
                  }
                  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='çŸ¥é“äº†'; btn.style.marginTop='12px'; btn.onclick=()=>modal.remove();
                  box.appendChild(h); box.appendChild(p); box.appendChild(btn); modal.appendChild(box);
                  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.remove(); });
                  document.body.appendChild(modal);
                }
                // æ•è·å®‰è£…äº‹ä»¶ï¼ˆä»…å®‰å…¨ä¸Šä¸‹æ–‡ï¼‰
                window.addEventListener('beforeinstallprompt', (e) => {
                  try{ e.preventDefault(); }catch(_){ }
                  deferredPrompt = e; show();
                });
                // å§”æ‰˜æŒ‰é’®ç‚¹å‡»ï¼ˆæŒ‰é’®å¯èƒ½åœ¨è„šæœ¬åæ¸²æŸ“ï¼‰
                document.addEventListener('click', async (ev) => {
                  const b = ev.target && (ev.target.id === 'installBtn' ? ev.target : ev.target.closest && ev.target.closest('#installBtn'));
                  if (!b) return;
                  // ä¼˜å…ˆä½¿ç”¨åŸç”Ÿå®‰è£…æç¤ºï¼ˆä»…å®‰å…¨ä¸Šä¸‹æ–‡ï¼‰
                  if (deferredPrompt){
                    try{ deferredPrompt.prompt(); await deferredPrompt.userChoice; }catch(_){ }
                    finally{ deferredPrompt = null; hide(); }
                    return;
                  }
                  // åœ¨ HTTP æˆ–æ— æç¤ºæ—¶ï¼Œç»™å‡ºå„å¹³å°æŒ‡å¼•
                  show(); // ç¡®ä¿æŒ‰é’®å¯è§
                  showHelpModal();
                }, true);
                // é¦–æ¬¡åŠ è½½ï¼šæœªå®‰è£…åˆ™æ˜¾ç¤ºæŒ‰é’®ï¼ˆå³ä¾¿æ—  beforeinstallpromptï¼Œåœ¨ HTTP ä¸‹ä¹Ÿæä¾›æ‰‹åŠ¨æŒ‡å¼•ï¼‰
                window.addEventListener('load', () => {
                  if (installed()) { hide(); return; }
                  show();
                });
            })();
        </script>
    <div class="container">
        {userbar}
        {notice_html}
        <div class="header">
            <h1>OQQWall å®¡æ ¸é¢æ¿</h1>
            <p>ç®¡ç†æ ¡å›­å¢™æŠ•ç¨¿å†…å®¹ï¼Œç¡®ä¿å†…å®¹è´¨é‡å’Œç¤¾åŒºè§„èŒƒ</p>
        </div>
        <div style="display:flex;justify-content:flex-start;gap:8px;margin:16px 0px" ;>
            <a href="/list" class="btn btn-info"><span class="ico">ğŸ“‹</span><span class="label">åˆ‡æ¢åˆ—è¡¨æ¨¡å¼</span></a>
            <button id="installBtn" class="btn btn-primary" style="display:none"><span class="ico">â¬‡ï¸</span><span class="label">å®‰è£…åº”ç”¨</span></button>
        </div>
        <div class="sep">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">{total_count}</div>
                    <div class="stat-label">å¾…å®¡é¡¹ç›®</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{anonymous_count}</div>
                    <div class="stat-label">åŒ¿åæŠ•ç¨¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{with_images_count}</div>
                    <div class="stat-label">åŒ…å«å›¾ç‰‡</div>
                </div>
            </div>
            <div class="top-right">
                <div class="filters">
                    <form method="get" action="/" class="filter-row">
                        <div class="filter-group">
                            <input type="text" id="search" name="search" class="filter-input" value="{search}"
                                placeholder="æœç´¢ç”¨æˆ·IDã€æ˜µç§°æˆ–å†…å®¹...">
                        </div>
                        <button type="submit" class="btn btn-primary"
                            style="background-color: var(--color-primary); color: white;">ğŸ” ç­›é€‰</button>
                        <a href="/" class="btn btn-secondary"
                            style="background-color: var(--color-surface-container-high);">ğŸ”„ é‡ç½®</a>
                    </form>
                </div>

                <div class="global-controls">
                    <h2>å…¨å±€æ“ä½œ</h2>
                    <form method="post" action="/api/cmd" class="global-row" id="globalCmdForm">
                        <!-- å¼ºåˆ¶ä»¥ä¸»è´¦å·æ‰§è¡Œ -->
                        <input type="hidden" name="self_id" value="{main_self_id}">
                        <div class="note">ä»¥ä¸»è´¦å·æ‰§è¡Œï¼š{main_self_id}</div>
                        <div class="row-1">
                            <button class="btn global-btn" name="object" value="å¾…å¤„ç†">
                                <span class="ico">ğŸ“‹</span>
                                <span class="label"><span class="nb">å¾…å¤„ç†</span></span>
                            </button>

                            <button class="btn global-btn" name="object" value="å‘é€æš‚å­˜åŒº">
                                <span class="ico">ğŸ“¨</span>
                                <span class="label">å‘é€<wbr><span class="nb">æš‚å­˜åŒº</span></span>
                            </button>

                            <button class="btn global-btn" name="object" value="åˆ é™¤æš‚å­˜åŒº">
                                <span class="ico">ğŸ§¹</span>
                                <span class="label">åˆ é™¤<wbr><span class="nb">æš‚å­˜åŒº</span></span>
                            </button>

                            <button class="btn global-btn" name="object" value="åˆ é™¤å¾…å¤„ç†">
                                <span class="ico">ğŸ—‘ï¸</span>
                                <span class="label">åˆ é™¤<wbr><span class="nb">å¾…å¤„ç†</span></span>
                            </button>

                        </div>
                        <div class="row-2">
                            <input class="num-input" type="number" name="number" placeholder="ç¼–å·è¾“å…¥">
                            <button class="btn global-btn" name="object" value="è®¾å®šç¼–å·"><span class="ico">#</span><span
                                    class="label">è®¾å®š<wbr>ç¼–å·</span></button>
                            <button class="btn global-btn" name="object" value="è°ƒå‡º"><span class="ico">ğŸ“¥</span><span
                                    class="label">è°ƒå‡º</span></button>
                            <button class="btn btn-info global-btn" name="object" value="è‡ªåŠ¨é‡æ–°ç™»å½•"><span
                                    class="ico">ğŸ”</span><span class="label">è‡ªåŠ¨<wbr>é‡æ–°ç™»å½•</span></button>
                            <button class="btn btn-info global-btn" name="object" value="æ‰‹åŠ¨é‡æ–°ç™»å½•"><span
                                    class="ico">ğŸ”‘</span><span class="label">æ‰‹åŠ¨<wbr>é‡æ–°ç™»å½•</span></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="staging-area" style="display:none">
            <h2>æš‚å­˜åŒºé¢„è§ˆ</h2>
            <div id="staging-grid" class="staging-grid">
            </div>
        </div>

        <div class="items-grid">
            {rows}
        </div>
    </div>

    <script>
        // ç€‘å¸ƒæµæ¨¡å¼çš„å…¨å±€æŒ‰é’®ä¸éœ€è¦å“åº”å¼å¤„ç†ï¼Œå§‹ç»ˆæ˜¾ç¤ºå®Œæ•´æ–‡å­—

        // ======= è‡ªé€‚åº”å›¾ç‰‡æ•°é‡ç®¡ç† =======
        (function () {
            function updateImageCols() {
                document.querySelectorAll('.item-card').forEach(card => {
                    const imagesContainer = card.querySelector('.item-images');
                    if (!imagesContainer) return;

                    const images = imagesContainer.querySelectorAll('img');
                    if (images.length === 0) return;

                    // è·å–å¡ç‰‡å†…å®¹åŒºåŸŸå®½åº¦ï¼Œå‡å»padding
                    const cardContent = card.querySelector('.item-content');
                    if (!cardContent) return;

                    const contentWidth = cardContent.offsetWidth - 40; // å‡å»padding
                    const minColWidth = 80;
                    const gap = 12;
                    const badgeSpace = 96; // badgeé¢„ç•™ç©ºé—´

                    // å…ˆå°è¯•åŒ…å«badgeç©ºé—´çš„å¸ƒå±€
                    const availableWidthWithBadge = contentWidth - badgeSpace;
                    const maxColsWithBadge = Math.floor((availableWidthWithBadge + gap) / (minColWidth + gap));

                    // å†è®¡ç®—ä¸åŒ…å«badgeç©ºé—´æ—¶èƒ½æ˜¾ç¤ºå¤šå°‘åˆ—
                    const maxColsWithoutBadge = Math.floor((contentWidth + gap) / (minColWidth + gap));

                    let optimalCols, showBadge, alignRight = false;

                    // å¦‚æœåŒ…å«badgeç©ºé—´è¿˜èƒ½æ˜¾ç¤ºå¤šåˆ—ï¼Œæˆ–è€…èƒ½æ˜¾ç¤º1åˆ—+badgeï¼Œåˆ™æ˜¾ç¤ºbadge
                    if (maxColsWithBadge >= 2 || (maxColsWithBadge >= 1 && maxColsWithoutBadge >= 2)) {
                        optimalCols = Math.max(1, maxColsWithBadge);
                        showBadge = true;
                    } else {
                        // å¦åˆ™éšè—badgeï¼Œå›¾ç‰‡é å³æ˜¾ç¤º
                        optimalCols = Math.max(1, maxColsWithoutBadge);
                        showBadge = false;
                        alignRight = true;
                    }

                    // é™åˆ¶åˆ—æ•°åœ¨1-6ä¹‹é—´ï¼Œä¸”ä¸è¶…è¿‡å®é™…å›¾ç‰‡æ•°é‡
                    optimalCols = Math.min(optimalCols, Math.min(6, images.length));

                    // è®¾ç½®CSSå˜é‡å’Œå¯¹é½æ–¹å¼
                    imagesContainer.style.setProperty('--img-cols', optimalCols);
                    if (alignRight) {
                        imagesContainer.style.justifyContent = 'flex-end';
                        imagesContainer.style.marginLeft = 'auto';
                        imagesContainer.style.maxWidth = 'fit-content';
                    } else {
                        imagesContainer.style.justifyContent = 'flex-start';
                        imagesContainer.style.marginLeft = '0';
                        imagesContainer.style.maxWidth = 'none';
                    }

                    // æ˜¾ç¤ºå›¾ç‰‡
                    const displayedImages = optimalCols * 2;
                    images.forEach((img, index) => {
                        img.style.display = index < displayedImages ? 'block' : 'none';
                    });

                    // æ§åˆ¶badgeæ˜¾ç¤º
                    const badges = card.querySelector('.item-badges');
                    if (badges) {
                        badges.style.display = showBadge ? 'flex' : 'none';
                    }
                });
            }

            // åˆå§‹åŒ–å’Œå“åº”å¼æ›´æ–°
            window.addEventListener('load', updateImageCols);
            window.addEventListener('resize', updateImageCols);

            // åœ¨å›¾ç‰‡åŠ è½½åæ›´æ–°
            document.addEventListener('load', (e) => {
                if (e.target.tagName === 'IMG') {
                    updateImageCols();
                }
            }, true);
            // å¦‚æœå›¾ç‰‡è§£ç å¤±è´¥ï¼Œå°è¯•å›é€€åˆ° data-fallbackï¼ˆ/cache/... è·¯ç”±ï¼‰
            document.addEventListener('error', (e) => {
                const img = e.target;
                if (img && img.tagName === 'IMG') {
                    const fb = img.getAttribute('data-fallback');
                    if (fb && img.src !== fb) {
                        img.src = fb;
                    }
                }
            }, true);

            // æš´éœ²å‡½æ•°ä¾›å…¶ä»–æ¨¡å—è°ƒç”¨
            window._updateImageCols = updateImageCols;
        })();

        // ======= Masonryï¼ˆGrid æ¨ªå‘ä¼˜å…ˆå¡«å……ï¼Œç¨³å¥ç‰ˆï¼‰ =======
        (function () {
            function getGrid() { return document.querySelector('.items-grid'); }
            function rowMetrics(grid) {
                const cs = window.getComputedStyle(grid);
                const rowGap = 0; // è¡Œé—´è·å›ºå®šä¸º0ï¼Œç”±å¡ç‰‡marginæä¾›
                let rowH = parseFloat(cs.gridAutoRows);
                if (!rowH || isNaN(rowH)) rowH = 1; // ä½¿ç”¨1pxå•å…ƒå‡å°‘é‡åŒ–è¯¯å·®
                return { rowGap, rowH };
            }
            function measure(card) {
                const grid = getGrid(); if (!grid || !card) return;
                const { rowGap, rowH } = rowMetrics(grid);
                const target = card.querySelector('form') || card;
                const h0 = Math.ceil(target.scrollHeight || target.getBoundingClientRect().height);
                const mb = parseFloat(getComputedStyle(card).marginBottom || '0') || 0;
                const h = h0 + mb;
                const span = Math.max(1, Math.ceil(h / rowH));
                card.style.gridRowEnd = 'span ' + span;
            }
            function layoutAll() {
                const grid = getGrid(); if (!grid) return;
                // é¦–å…ˆæ›´æ–°å›¾ç‰‡åˆ—æ•°
                if (window._updateImageCols) window._updateImageCols();
                // é¦–å¸§ä½¿ç”¨ auto è¡Œé«˜æ¸²æŸ“çœŸå®é«˜åº¦ï¼Œé¿å…ç»†æ¡
                grid.style.gridAutoRows = 'auto';
                requestAnimationFrame(() => {
                    grid.querySelectorAll('.item-card').forEach(measure);
                    grid.style.gridAutoRows = '1px';
                });
            }
            function onImgLoad(e) {
                const img = e.target; if (!img || img.tagName !== 'IMG') return;
                const card = img.closest('.item-card'); if (!card) return;
                measure(card);
            }
            const mo = new MutationObserver((records) => {
                for (const r of records) {
                    r.addedNodes && r.addedNodes.forEach(node => {
                        if (node && node.nodeType === 1) {
                            if (node.classList.contains('item-card')) requestAnimationFrame(() => measure(node));
                            node.querySelectorAll && node.querySelectorAll('.item-card').forEach(el => requestAnimationFrame(() => measure(el)));
                        }
                    });
                }
            });
            let ro;
            try { ro = new ResizeObserver((entries) => { for (const e of entries) { if (e.target) measure(e.target); } }); } catch (_) { }
            window.addEventListener('load', () => {
                const grid = getGrid();
                if (grid) {
                    mo.observe(grid, { childList: true, subtree: true });
                    grid.querySelectorAll('.item-card').forEach(el => ro && ro.observe(el));
                }
                layoutAll();
                if (document.fonts && document.fonts.ready) document.fonts.ready.then(layoutAll);
            });
            window.addEventListener('resize', () => { clearTimeout(window.__mz_r); window.__mz_r = setTimeout(layoutAll, 150); });
            document.addEventListener('load', onImgLoad, true);
            window._masonry = { measure, layoutAll };
        })();
        // ======= è½»é‡çº§å›¾ç‰‡æµè§ˆå™¨ï¼ˆæ”¯æŒå·¦å³é”®å’Œç§»åŠ¨ç«¯æŒ‰é’®ï¼‰ =======
        (function () {
            let modal = null, imgEl = null, leftBtn = null, rightBtn = null, currentIdx = 0, list = [];
            function close() { if (modal) { modal.remove(); modal = null; list = []; } }
            function render() { if (!imgEl) return; imgEl.src = list[currentIdx]; }
            function createButtons() {
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                if (isMobile) {
                    leftBtn = document.createElement('button');
                    rightBtn = document.createElement('button');
                    leftBtn.textContent = 'â€¹'; rightBtn.textContent = 'â€º';
                    [leftBtn, rightBtn].forEach(b => { b.style.cssText = 'position:absolute;bottom:12px;background:#21005D;opacity:.9;color:#fff;border:none;border-radius:999px;padding:10px 14px;font-size:18px;pointer-events:auto;' });
                    leftBtn.style.left = '12px'; rightBtn.style.right = '12px';
                    leftBtn.onclick = (e) => { e.stopPropagation(); currentIdx = (currentIdx - 1 + list.length) % list.length; render(); };
                    rightBtn.onclick = (e) => { e.stopPropagation(); currentIdx = (currentIdx + 1) % list.length; render(); };
                    modal.appendChild(leftBtn); modal.appendChild(rightBtn);
                }
            }
            function open(startUrl, urls) {
                list = urls.slice(); currentIdx = list.indexOf(startUrl); if (currentIdx < 0) currentIdx = 0;
                modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2147483646;cursor:zoom-out;';
                imgEl = document.createElement('img');
                imgEl.style.cssText = 'max-width:94vw;max-height:94vh;object-fit:contain;border-radius:8px;';
                modal.appendChild(imgEl);
                createButtons();
                document.body.appendChild(modal);
                render();
                modal.onclick = close;
                document.addEventListener('keydown', onKey);
            }
            function onKey(e) {
                if (!modal) return;
                if (e.key === 'Escape') { close(); document.removeEventListener('keydown', onKey); return; }
                if (e.key === 'ArrowLeft') { currentIdx = (currentIdx - 1 + list.length) % list.length; render(); }
                if (e.key === 'ArrowRight') { currentIdx = (currentIdx + 1) % list.length; render(); }
            }
            window._openImageBrowser = open;
        })();
        // ======= Toast Manager =======
        (function () {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.style.position = 'fixed';
            container.style.zIndex = '2147483647';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '8px';
            container.style.pointerEvents = 'none';
            function position() {
                if (window.matchMedia('(max-width: 768px)').matches) {
                    container.style.top = '8px';
                    container.style.bottom = '';
                    container.style.left = '50%';
                    container.style.transform = 'translateX(-50%)';
                    container.style.right = '';
                    container.style.alignItems = 'center';
                } else {
                    container.style.bottom = '12px';
                    container.style.left = '12px';
                    container.style.top = '';
                    container.style.right = '';
                    container.style.transform = '';
                    container.style.alignItems = 'flex-start';
                }
            }
            position();
            window.addEventListener('resize', position);
            document.body.appendChild(container);

            const shown = [];
            function showToast(text, level = 'info') {
                const el = document.createElement('div');
                el.style.cssText = 'background:#21005D;color:#fff;opacity:.95;padding:10px 12px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.25);pointer-events:auto;transition:opacity .4s ease, transform .4s ease;';
                if (level === 'success') el.style.background = '#155724';
                if (level === 'error') el.style.background = '#b3261e';
                el.textContent = text;
                // æŒ¤å‹ï¼šæœ€å¤š4ä¸ªï¼Œå¤šçš„æ·¡å‡º
                if (shown.length >= 4) {
                    const old = shown.shift();
                    old.style.opacity = '0';
                    setTimeout(() => old.remove(), 400);
                }
                container.appendChild(el);
                shown.push(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(6px)';
                    setTimeout(() => {
                        const idx = shown.indexOf(el);
                        if (idx >= 0) shown.splice(idx, 1);
                        el.remove();
                    }, 400);
                }, 5000);
            }
            // è¿æ¥ SSE
            try {
                const es = new EventSource('/events');
                es.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        if (data.type === 'toast') {
                            showToast(data.text || 'æ“ä½œå®Œæˆ', data.level || 'info');
                        } else if (data.type === 'new_pending') {
                            // è‡ªåŠ¨æ‹‰å–å¹¶æ’å…¥æ–°å¡ç‰‡
                            const grid = document.querySelector('.items-grid');
                            if (!grid) return;
                            const curMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
                            fetch('/api/pending_tags').then(r => r.json()).then(async (j) => {
                                const tags = (j.tags || []).map(t => parseInt(t, 10)).filter(n => !isNaN(n));
                                const newTags = tags.filter(n => n > curMax).sort((a, b) => a - b);
                                if (newTags.length) {
                                    for (const t of newTags) {
                                        try {
                                            const cr = await fetch('/api/card?tag=' + encodeURIComponent(String(t)));
                                            if (cr.ok) {
                                                const d = await cr.json();
                                                const wrap = document.createElement('div');
                                                wrap.innerHTML = d.html;
                                                const card = wrap.firstElementChild;
                                                if (card) {
                                                    grid.insertAdjacentElement('afterbegin', card);
                                                    card.classList.add('highlight-new');
                                                    // æ›´æ–°æ–°å¡ç‰‡çš„å›¾ç‰‡å¸ƒå±€
                                                    if (window._updateImageCols) window._updateImageCols();
                                                    setTimeout(() => card.classList.remove('highlight-new'), 1500);
                                                }
                                            }
                                        } catch (_) {/* ignore */ }
                                    }
                                    window._knownMaxTag = Math.max.apply(null, tags);
                                }
                            }).catch(() => { });
                            showToast('æœ‰æ–°æŠ•ç¨¿åŠ å…¥é˜Ÿåˆ—', 'info');
                        } else if (data.type === 'undo') {
                            // å¯é€‰ï¼šæç¤ºæ’¤é”€å®Œæˆ
                            showToast('å·²ä»æš‚å­˜åŒºæ’¤å› #' + data.tag, 'success');
                        } else if (data.type === 'processed') {
                            // ç¾¤æŒ‡ä»¤/åå°å¤„ç†å¯¼è‡´çš„é¡¹ç›®çŠ¶æ€å˜æ›´ -> åŒæ­¥æ ‡è®°ä¸ºå·²å¤„ç†
                            const cardInput = document.querySelector('.item-card input[name="tag"][value="' + String(data.tag) + '"]');
                            const card = cardInput ? cardInput.closest('.item-card') : null;
                            if (card) {
                                markProcessed(card);
                            }
                        }
                    } catch (_) {/* ignore */ }
                };
            } catch (_) {/* ignore */ }
            // æš´éœ²å…¨å±€ä»¥ä¾¿è°ƒè¯•
            window._toast = showToast;
            window._knownMaxTag = parseInt('{initial_max_tag}', 10) || 0;
        })();
        // ======= æ— åˆ·æ–°æ“ä½œ & æ–°æŠ•ç¨¿æç¤º =======
        function markProcessed(card) {
            card.classList.add('processed');
            const actions = card.querySelector('.item-actions');
            if (actions) {
                // é”å®šå½“å‰æ“ä½œåŒºé«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºâ€œå·²å¤„ç†â€æ—¶é«˜åº¦å˜åŒ–å½±å“å¸ƒå±€
                const prevH = actions.offsetHeight;
                if (prevH > 0) {
                    actions.style.height = prevH + 'px';
                    actions.style.minHeight = prevH + 'px';
                }
                actions.style.display = 'flex';
                actions.style.alignItems = 'center';
                actions.style.justifyContent = 'center';
                actions.style.gap = '0';
                actions.innerHTML = '<div class="btn" style="background:#D4EDDA;color:#155724;min-width:160px;text-align:center">âœ… å·²å¤„ç†</div>';
            }
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[name="cmd"]');
            if (!btn) return;
            const form = btn.closest('form');
            if (!form) return;
            // æ‹¦æˆªé»˜è®¤æäº¤
            e.preventDefault();
            const card = form.closest('.item-card');
            const tag = form.querySelector('input[name="tag"]').value;
            const flag = form.querySelector('textarea[name="flag"]')?.value || '';
            const cmd = btn.value;
            try {
                const res = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ tag, cmd, flag })
                });
                if (res.ok) {
                    if (cmd === 'è¯„è®º') {
                        const ta = form.querySelector('textarea[name="flag"]');
                        if (ta) ta.value = '';
                    } else {
                        markProcessed(card);
                    }
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼ŒçŠ¶æ€ç  ' + res.status);
                }
            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±è´¥ï¼š' + err);
            }
        });

        // é˜²æ­¢å¡ç‰‡è¡¨å•é»˜è®¤æäº¤å¯¼è‡´é¡µé¢è·³åˆ°é¡¶éƒ¨
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (form && form.querySelector('input[name="tag"]')) {
                e.preventDefault();
            }
        });

        // æ–°æŠ•ç¨¿æç¤ºï¼šè½®è¯¢ pending_meta
        (function setupNewPostNotifier() {
            let knownMax = window._knownMaxTag || parseInt('{initial_max_tag}', 10) || 0;
            let toast;
            function showToast() {
                if (toast) return;
                toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;right:12px;bottom:12px;background:#EADDFF;color:#21005D;padding:12px 14px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:2000;display:flex;gap:8px;align-items:center;';
                toast.innerHTML = '<span>æœ‰æ–°æŠ•ç¨¿åŠ å…¥é˜Ÿåˆ—</span>';
                const btn = document.createElement('button');
                btn.textContent = 'åˆ·æ–°åˆ—è¡¨';
                btn.className = 'btn';
                btn.style.background = '#6750A4';
                btn.style.color = '#fff';
                btn.onclick = () => location.reload();
                toast.appendChild(btn);
                document.body.appendChild(toast);
            }
            async function tick() {
                try {
                    const r = await fetch('/api/pending_meta');
                    if (!r.ok) return;
                    const data = await r.json();
                    const maxTag = parseInt(data.max_tag || 0, 10);
                    if (maxTag > knownMax) {
                        knownMax = maxTag;
                        window._knownMaxTag = knownMax;
                        showToast();
                    }
                } catch (err) { console.warn('pending_meta error', err); }
            }
            setInterval(tick, 12000);
        })();
        // å›¾ç‰‡ç‚¹å‡» -> æ‰“å¼€æµè§ˆå™¨
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.item-images')) {
                const imgs = Array.from(e.target.closest('.item-images').querySelectorAll('img')).map(x => x.src);
                _openImageBrowser(e.target.src, imgs);
            }
        });
        // ç‚¹å‡»æ ‡é¢˜ #tag -> é¢„è§ˆå¼¹çª—ï¼ˆiframeï¼‰
        function openPreview(tag) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:2147483646;';
            const frame = document.createElement('iframe');
            frame.src = '/detail_html?tag=' + encodeURIComponent(tag);
            frame.style.cssText = 'width:min(92vw, 900px); height:80vh; background:#fff; border-radius:12px; border:1px solid #e5e5ef';
            modal.appendChild(frame);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }
        document.addEventListener('click', (e) => {
            const tagEl = e.target.closest('.item-tag');
            if (tagEl) {
                const form = tagEl.closest('form');
                const tag = form?.querySelector('input[name="tag"]').value;
                if (tag) { e.preventDefault(); openPreview(tag); }
            }
        });

        // æ“ä½œæŒ‰é’®ç¡®è®¤
        document.addEventListener('click', (e) => {
            if (e.target.matches('button[name="cmd"][value="åˆ "], button[name="cmd"][value="æ‹’"], button[name="cmd"][value="æ‹‰é»‘"]')) {
                if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    e.preventDefault();
                }
            }
        });

        // æš‚å­˜åŒºè‡ªåŠ¨åˆ·æ–°é€»è¾‘
        function updateStagingArea() {
            const staging = document.querySelector('.staging-area');
            if (!staging) return;
            // å¦‚æœé…ç½®ä¸ºéšè—æš‚å­˜åŒºï¼Œç›´æ¥éšè—å¹¶é€€å‡º
            if (window.HIDE_STAGING === true || window.HIDE_STAGING === 'true') {
                staging.style.display = 'none';
                return;
            }
            fetch('/api/staged')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

                    if (Object.keys(data).length === 0) {
                        // æš‚å­˜ä¸ºç©ºï¼šéšè—æ•´ä¸ªæš‚å­˜åŒºå®¹å™¨
                        staging.style.display = 'none';
                        return;
                    }

                    // æœ‰å†…å®¹ï¼šæ˜¾ç¤ºå®¹å™¨
                    staging.style.display = '';

                    for (const groupName in data) {
                        const items = data[groupName];
                        items.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'staged-item';
                            // thumbs
                            const th = document.createElement('div');
                            th.className = 'thumbs';
                            const thumbs = Array.isArray(item.thumbs) ? item.thumbs.slice(0, 3) : [];
                            thumbs.forEach(fn => {
                                const img = document.createElement('img');
                                const dir = item.img_source_dir || 'prepost';
                                const base = (window.IMG_BASE || '/i').replace(/\/$/, '');
                                img.src = `${base}/${dir}/${item.tag}/${fn}`;
                                img.alt = `#${item.tag}`;
                                img.loading = 'lazy';
                                th.appendChild(img);
                            });
                            // meta + info
                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            meta.innerHTML = `<span class="group">${groupName}</span> <span class="tag">#${item.tag}</span>`;
                            const undoBtn = document.createElement('button');
                            undoBtn.className = 'btn';
                            undoBtn.textContent = 'â†© æ’¤é”€';
                            undoBtn.onclick = async (ev) => {
                                ev.preventDefault();
                                if (!confirm('ç¡®è®¤å°† #' + item.tag + ' ä»æš‚å­˜åŒºæ’¤å›åˆ°å¾…å¤„ç†ï¼Ÿ')) return;
                                try {
                                    const r = await fetch('/api/staged_undo', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ tag: String(item.tag) }) });
                                    if (r.ok) {
                                        // ä»æš‚å­˜åŒºç§»é™¤
                                        div.remove();
                                        // å°è¯•å°†å¡ç‰‡æ’å…¥å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆé‡è¯•å‡ æ¬¡ï¼‰
                                        const grid = document.querySelector('.items-grid');
                                        if (grid) {
                                            let tries = 0;
                                            const tryFetch = async () => {
                                                tries++;
                                                try {
                                                    const cr = await fetch('/api/card?tag=' + encodeURIComponent(item.tag));
                                                    if (cr.ok) {
                                                        const data = await cr.json();
                                                        const wrap = document.createElement('div');
                                                        wrap.innerHTML = data.html;
                                                        const card = wrap.firstElementChild;
                                                        if (card) {
                                                            grid.insertAdjacentElement('afterbegin', card);
                                                            card.classList.add('highlight-new');
                                                            // æ›´æ–°æ–°å¡ç‰‡çš„å›¾ç‰‡å¸ƒå±€
                                                            if (window._updateImageCols) window._updateImageCols();
                                                            setTimeout(() => card.classList.remove('highlight-new'), 1500);
                                                            return;
                                                        }
                                                    }
                                                } catch (_) { }
                                                if (tries < 6) setTimeout(tryFetch, 800);
                                            };
                                            tryFetch();
                                        }
                                    } else {
                                        alert('æ’¤é”€å¤±è´¥ï¼š' + r.status);
                                    }
                                } catch (err) { alert('æ’¤é”€å¤±è´¥ï¼š' + err); }
                            };
                            const undoWrap = document.createElement('div');
                            undoWrap.className = 'undo';
                            undoWrap.appendChild(undoBtn);
                            const info = document.createElement('div');
                            info.className = 'info';
                            const nick = item.nickname || 'æœªçŸ¥';
                            const sender = item.senderid || '';
                            info.textContent = `${nick}${sender ? ' (' + sender + ')' : ''}`;
                            // assemble
                            div.appendChild(th);
                            div.appendChild(meta);
                            div.appendChild(info);
                            div.appendChild(undoWrap);
                            grid.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching staged items:', error);
                    const grid = document.getElementById('staging-grid');
                    grid.innerHTML = '<p style="color: var(--color-error);">åŠ è½½æš‚å­˜åŒºå¤±è´¥</p>';
                });
        }

        // é¡µé¢åŠ è½½æ—¶ç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œä¹‹åæ¯15ç§’åˆ·æ–°ä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', () => {
            updateStagingArea();
            setInterval(updateStagingArea, 15000);
            // å…¨å±€å±é™©åŠ¨ä½œç¡®è®¤
            const form = document.getElementById('globalCmdForm');
            form.addEventListener('click', (e) => {
                if (e.target.name === 'object' && ['åˆ é™¤æš‚å­˜åŒº', 'åˆ é™¤å¾…å¤„ç†'].includes(e.target.value)) {
                    if (!confirm('ç¡®å®šæ‰§è¡Œâ€œ' + e.target.value + 'â€å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                        e.preventDefault();
                    }
                }
            });
        });
    </script>
</body>

</html>
