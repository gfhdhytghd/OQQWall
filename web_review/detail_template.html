<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç¨¿ä»¶è¯¦æƒ… #{tag}</title>
  <style>
    :root { --color-primary:#6750A4; --color-primary-container:#EADDFF; --color-on-primary-container:#21005D; --color-surface:#F7F2FA; --color-surface-0:#FFFFFF; --color-outline:#CAC4D0; --color-text:#1C1B1F; --color-text-sub:#49454F; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft Yahei",sans-serif; background: var(--color-surface); color: var(--color-text); }
    /* é™åˆ¶æ•´é¡µå®½åº¦ä¸è¶…è¿‡é«˜åº¦çš„ 180%ï¼ˆå³ 180vhï¼‰ï¼Œå¹¶åœ¨å¤§å±ä¸‹ç•™å‡ºè¾¹è· */
    .wrap { max-width: min(180vh, 96vw); margin:0 auto; padding:16px; }
    .topbar { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    .back { text-decoration:none; color:#fff; background:#17a2b8; padding:8px 12px; border-radius:999px; }
    .card { background: var(--color-surface-0); border:1px solid var(--color-outline); border-radius: 16px; box-shadow:0 1px 3px rgba(0,0,0,.05); margin-bottom: 16px; overflow:hidden; }
    .card .hd { padding:14px 16px; border-bottom:1px solid var(--color-outline); display:flex; justify-content:space-between; align-items:center; }
    .card .bd { padding:16px; }
    .title { margin:0; font-size:18px; font-weight:600; }
    .meta { color: var(--color-text-sub); font-size:14px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid .cell { background: var(--color-surface); border-radius:12px; padding:12px; }
    .content { background: var(--color-surface); border-left:4px solid var(--color-primary-container); border-radius:12px; padding:12px; word-break: break-word; }
    .images { display:flex; gap:10px; overflow-x:auto; padding-bottom:2px; }
    .images img { height:220px; max-width:100%; object-fit:cover; border-radius:12px; border:2px solid var(--color-outline); flex:0 0 auto; cursor:pointer; }
    .code { background:#0f172a; color:#e5e7eb; padding:12px; border-radius:12px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .actions { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .btn { padding:10px 14px; border:none; border-radius:999px; cursor:pointer; font-weight:600; }
    /* æ“ä½œåŒºæŒ‰é’®ï¼šåŠé€æ˜å¡«å…… + 2px å®å¿ƒå†…è¾¹æ¡† */
    .actions .btn { background: rgba(202,196,208,.35); box-shadow: inset 0 0 0 2px #CAC4D0; color:#000; }
    .actions .btn-info { background: rgba(23,162,184,.35); color:#000; box-shadow: inset 0 0 0 2px #17a2b8; }
    .actions .btn-ok { background: rgba(40,167,69,.35); color:#000; box-shadow: inset 0 0 0 2px #28a745; }
    .actions .btn-warn { background: rgba(255,193,7,.35); color:#000; box-shadow: inset 0 0 0 2px #ffc107; }
    .actions .btn-danger { background: rgba(220,53,69,.35); color:#000; box-shadow: inset 0 0 0 2px #dc3545; }
    .flag { width:100%; padding:10px 16px; border:1px solid var(--color-outline); border-radius:999px; background:#fff; }
    /* Desktop two-panel layout with independent scroll: å·¦ 400pxï¼Œå³ä¾§è‡ªé€‚åº” */
    .detail-grid { display:grid; grid-template-columns: 400px minmax(0, 1fr); gap:16px; align-items:start; }
    .detail-grid .col { max-height: calc(100vh - 120px); overflow:auto; }
    @media (max-width: 768px) {
      .detail-grid { grid-template-columns: 1fr; }
      .detail-grid .col { max-height: none; overflow: visible; }
    }
  </style>
  <script>
    // è½»é‡çº§å›¾ç‰‡æµè§ˆå™¨ï¼ˆä¸åˆ—è¡¨é¡µä¸€è‡´ï¼‰
    (function(){
      let modal=null, imgEl=null, leftBtn=null, rightBtn=null, currentIdx=0, list=[];
      function close(){ if(modal){ modal.remove(); modal=null; list=[]; document.removeEventListener('keydown', onKey);} }
      function render(){ if(!imgEl) return; imgEl.src=list[currentIdx]; }
      function createButtons(){
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (isMobile){
          leftBtn = document.createElement('button'); rightBtn = document.createElement('button');
          leftBtn.textContent='â€¹'; rightBtn.textContent='â€º';
          [leftBtn,rightBtn].forEach(b=>{ b.style.cssText='position:absolute;bottom:12px;background:#21005D;opacity:.9;color:#fff;border:none;border-radius:999px;padding:10px 14px;font-size:18px;pointer-events:auto;'});
          leftBtn.style.left='12px'; rightBtn.style.right='12px';
          leftBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx-1+list.length)%list.length; render(); };
          rightBtn.onclick=(e)=>{ e.stopPropagation(); currentIdx=(currentIdx+1)%list.length; render(); };
          modal.appendChild(leftBtn); modal.appendChild(rightBtn);
        }
      }
      function onKey(e){ if(!modal) return; if(e.key==='Escape'){ close(); } if(e.key==='ArrowLeft'){ currentIdx=(currentIdx-1+list.length)%list.length; render(); } if(e.key==='ArrowRight'){ currentIdx=(currentIdx+1)%list.length; render(); } }
      function open(startUrl, urls){ list=urls.slice(); currentIdx=list.indexOf(startUrl); if(currentIdx<0) currentIdx=0; modal=document.createElement('div'); modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2147483646;cursor:zoom-out;'; imgEl=document.createElement('img'); imgEl.style.cssText='max-width:94vw;max-height:94vh;object-fit:contain;border-radius:8px;'; modal.appendChild(imgEl); createButtons(); document.body.appendChild(modal); render(); modal.onclick=close; document.addEventListener('keydown', onKey); }
      document.addEventListener('click', (e)=>{ if (e.target.tagName==='IMG' && e.target.closest('.images')){ const imgs=Array.from(e.target.closest('.images').querySelectorAll('img')).map(x=>x.src); open(e.target.src, imgs); } });
    })();
    // æ‹¦æˆªæ“ä½œæŒ‰é’®ï¼ŒAJAX æäº¤å¹¶ç½®ä¸ºå·²å¤„ç†
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[name="cmd"]');
      if (!btn) return;
      const form = btn.closest('form');
      if (!form) return;
      e.preventDefault();
      const tag = form.querySelector('input[name="tag"]').value;
      const flag = form.querySelector('input[name="flag"], textarea[name="flag"]').value || '';
      const cmd = btn.value;
      try{
        const r = await fetch('/api/action', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({tag, cmd, flag})});
        if(r.ok){
          if (cmd === 'è¯„è®º'){
            const inp = form.querySelector('input[name="flag"], textarea[name="flag"]');
            if (inp) inp.value = '';
          } else {
            const actions = form;
            actions.innerHTML = '<div class="btn" style="background:#D4EDDA;color:#155724;width:100%;text-align:center">âœ… å·²å¤„ç†</div>';
          }
        }else{
          alert('æ“ä½œå¤±è´¥ï¼š' + r.status);
        }
      }catch(err){ alert('æ“ä½œå¤±è´¥ï¼š'+err); }
    });
    // é˜²æ­¢è¡¨å•é»˜è®¤æäº¤åˆ·æ–°
    document.addEventListener('submit', (e) => {
      const form = e.target;
      if (form && form.querySelector('input[name="tag"]')) {
        e.preventDefault();
      }
    });
  </script>
  <script>
    // ç§»åŠ¨ç«¯ï¼šé‡æ’é¡ºåº => æ“ä½œ, é¢„è§ˆ, åŸºæœ¬ä¿¡æ¯, å›¾ç‰‡, å†…å®¹, AfterLM
    (function(){
      function reorder(){
        if (!window.matchMedia('(max-width: 768px)').matches) return;
        const grid = document.querySelector('.detail-grid');
        if (!grid) return;
        const left = grid.querySelector('.col.left');
        const right = grid.querySelector('.col.right');
        if (!left || !right) return;
        const actions = right.querySelector('.card-actions');
        const preview = left.querySelector('.card-preview');
        const info = right.querySelector('.card-info');
        const images = right.querySelector('.card-images');
        const content = right.querySelector('.card-content');
        const after = right.querySelector('.card-afterlm');
        try{
          if (actions) left.insertBefore(actions, left.firstChild || null);
          if (preview) left.appendChild(preview);
          // å³ä¾§ï¼šinfo -> images -> content -> afterlm
          if (info) right.appendChild(info);
          if (images) right.appendChild(images);
          if (content) right.appendChild(content);
          if (after) right.appendChild(after);
        }catch(_){ }
      }
      document.addEventListener('DOMContentLoaded', reorder);
      // é¢„é˜²æå¿«çš„é¦–æ¬¡ç»˜åˆ¶ï¼šå†æ’ä¸€æ¬¡
      requestAnimationFrame(reorder);
      window.addEventListener('resize', ()=>{ clearTimeout(window.__detail_reorder); window.__detail_reorder = setTimeout(reorder, 150); });
    })();
  </script>
  <meta name="theme-color" content="#6750A4">
  <link rel="icon" href="data:,">
  <meta name="format-detection" content="telephone=no">
</head>
<body>
  <div class="wrap">
    {notice_html}
    <div class="topbar">
      <a class="back" href="/">â† è¿”å›åˆ—è¡¨</a>
      <h1 class="title" style="margin:0">ç¨¿ä»¶è¯¦æƒ… #{tag}</h1>
    </div>
    <div class="detail-grid">
      <div class="col left">
        <div class="card card-preview">
          <div class="hd"><h2 class="title">æ¸²æŸ“é¢„è§ˆ</h2></div>
          <div class="bd">
            <iframe src="/detail_html?tag={tag}" style="width:100%;height:70vh;border:1px solid #e5e5ef;border-radius:12px;background:#fff"></iframe>
            <div style="margin-top:8px;font-size:12px;color:#49454F">å¦‚æ— æ³•æ˜¾ç¤ºï¼Œè¯·<a href="/detail_html?tag={tag}" target="_blank">ç‚¹å‡»åœ¨æ–°çª—å£æ‰“å¼€</a></div>
          </div>
        </div>
      </div>
      <div class="col right">
        <div class="card card-actions">
          <div class="hd"><h2 class="title">æ“ä½œ</h2></div>
          <div class="bd">
            <form method="post" action="/" class="actions">
              <input type="hidden" name="tag" value="{tag}">
              <input type="hidden" name="redirect" value="/detail?tag={tag}">
              <button class="btn btn-danger" name="cmd" value="æ‹‰é»‘">ğŸš« æ‹‰é»‘</button>
              <input class="flag" type="text" name="flag" placeholder="è¯„è®ºæˆ–æ‹’ç»/æ‹‰é»‘åŸå› ï¼ˆå¯é€‰ï¼‰">
              <button class="btn" name="cmd" value="è¯„è®º">ğŸ’¬ è¯„è®º</button>
              <button class="btn" name="cmd" value="é‡æ¸²æŸ“">ğŸ¨ é‡æ¸²æŸ“</button>
              <button class="btn" name="cmd" value="å±•ç¤º">ğŸ–¼ï¸ å±•ç¤º</button>
              <button class="btn btn-info" name="cmd" value="æŸ¥">â„¹ï¸ æŸ¥æˆåˆ†</button>
              <button class="btn" name="cmd" value="åˆ·æ–°">ğŸ”„ åˆ·æ–°</button>
              <button class="btn btn-warn" name="cmd" value="æ‹’">âš ï¸ æ‹’ç»</button>
              <button class="btn" name="cmd" value="å¦">ğŸ™… å¦</button>
              <button class="btn btn-danger" name="cmd" value="åˆ ">âŒ åˆ é™¤</button>
              <button class="btn btn-info" name="cmd" value="ç«‹å³">ğŸš€ ç«‹å³</button>
              <button class="btn btn-ok" name="cmd" value="æ˜¯">âœ… é€šè¿‡</button>
            </form>
          </div>
        </div>
        <div class="card card-info">
          <div class="hd"><h2 class="title">åŸºæœ¬ä¿¡æ¯</h2></div>
          <div class="bd grid">
            <div class="cell"><div class="meta">æŠ•ç¨¿äºº</div><div>{nickname}ï¼ˆ{senderid}ï¼‰</div></div>
            <div class="cell"><div class="meta">æ—¶é—´</div><div>{submit_time}</div></div>
            <div class="cell"><div class="meta">ç›®æ ‡ç¾¤</div><div>{ACgroup} / {receiver}</div></div>
            <div class="cell"><div class="meta">åŒ¿å</div><div>{is_anonymous}</div></div>
          </div>
        </div>
        <div class="card card-content">
          <div class="hd"><h2 class="title">å†…å®¹</h2></div>
          <div class="bd"><div class="content">{comment_html}</div></div>
        </div>
        <div class="card card-images">
          <div class="hd"><h2 class="title">å›¾ç‰‡</h2></div>
          <div class="bd">
            <details open>
              <summary style="cursor:pointer;user-select:none">å›¾ç‰‡ï¼ˆ{image_count}ï¼‰</summary>
              <div class="images" style="margin-top:8px">{images_html}</div>
            </details>
          </div>
        </div>
        <div class="card card-afterlm">
          <div class="hd"><h2 class="title">AfterLM åˆ†æ</h2></div>
          <div class="bd">
            <details>
              <summary style="cursor:pointer;user-select:none">å±•å¼€/æ”¶èµ·</summary>
              <pre class="code" style="margin-top:8px">{afterlm_pretty}</pre>
            </details>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
